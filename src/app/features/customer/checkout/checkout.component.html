<!-- src/app/features/customer/components/checkout/checkout.component.html -->

<div class="checkout-container">
  <div class="checkout-card">
    <h2>ğŸ›’ Checkout</h2>
    <p class="subtext">Almost there! Please confirm your delivery details below.</p>

    <form [formGroup]="form" (ngSubmit)="submit()" class="checkout-form">
      <!-- Customer Name -->
      <div class="form-group">
        <label>ğŸ‘¤ Customer Name *</label>
        <input type="text" formControlName="customerName" placeholder="Enter your name" class="form-control" />
        <small *ngIf="form.get('customerName')?.hasError('required') && form.get('customerName')?.touched"
          class="error">
          Name is required
        </small>
        <small *ngIf="form.get('customerName')?.hasError('minlength') && form.get('customerName')?.touched"
          class="error">
          Minimum 2 characters
        </small>
      </div>

      <!-- Phone -->
      <div class="form-group">
        <label>ğŸ“± Phone *</label>
        <input type="tel" formControlName="customerPhone" placeholder="10-digit phone number" maxlength="10"
          class="form-control" />
        <small *ngIf="form.get('customerPhone')?.hasError('pattern') && form.get('customerPhone')?.touched"
          class="error">
          Enter valid 10-digit phone number
        </small>
      </div>

      <!-- Email -->
      <!-- Email (Hid for Table QR) -->
      <div class="form-group" *ngIf="!isTableOrder">
        <label>ğŸ“§ Email *</label>
        <input type="email" formControlName="customerEmail" placeholder="your@email.com" class="form-control" />
        <small *ngIf="form.get('customerEmail')?.hasError('email') && form.get('customerEmail')?.touched" class="error">
          Enter valid email
        </small>
      </div>

      <!-- Address -->
      <!-- Address (Hid for Table QR) -->
      <div class="form-group" *ngIf="!isTableOrder">
        <label>ğŸ“ Delivery Address <span *ngIf="form.get('orderType')?.value === 'DELIVERY'"
            style="color:red">*</span></label>
        <textarea formControlName="address" placeholder="Enter your delivery address" rows="3"
          class="form-control"></textarea>
        <small *ngIf="form.get('address')?.hasError('required') && form.get('address')?.touched" class="error">
          Address is required
        </small>
      </div>

      <!-- Order Type (Hid/Locked for Table QR) -->
      <div class="form-group" *ngIf="!isTableOrder">
        <label>ğŸ“¦ Order Type *</label>
        <select formControlName="orderType" class="form-control">
          <option value="DELIVERY">ğŸšš Delivery</option>
          <option value="PICKUP">ğŸ“ Pickup</option>
          <option value="DINE_IN">ğŸ½ï¸ Dine In</option>
        </select>
      </div>

      <!-- Pincode Input (Only if Delivery) -->
      <div class="form-group" *ngIf="form.get('orderType')?.value === 'DELIVERY'">
        <label>ğŸ“® Pincode *</label>
        <input type="text" formControlName="deliveryPincode" placeholder="e.g. 560001" maxlength="6"
          class="form-control" />
        <small *ngIf="form.get('deliveryPincode')?.hasError('required') && form.get('deliveryPincode')?.touched"
          class="error">
          Pincode is required
        </small>
        <small *ngIf="form.get('deliveryPincode')?.hasError('pattern') && form.get('deliveryPincode')?.touched"
          class="error">
          Enter valid 6-digit pincode
        </small>
      </div>

      <!-- Location Link (Optional) -->
      <div class="form-group" *ngIf="form.get('orderType')?.value === 'DELIVERY'">
        <label>ğŸ“ Google Maps Link (Optional)</label>
        <input type="text" formControlName="locationLink" placeholder="Paste location link here" class="form-control" />
      </div>

      <!-- Delivery Unavailable Warning -->
      <div class="alert alert-danger" *ngIf="form.get('orderType')?.value === 'DELIVERY' && deliveryError">
        ğŸ›‘ {{ deliveryError }}
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <div class="summary-header">
          <h3>Order Summary</h3>
          <a routerLink="/menu" class="edit-link">Edit Order</a>
        </div>
        <div class="summary-items">
          <div *ngFor="let item of cart.items" class="item-line">
            <span>{{ item.menuItem.name }} Ã— {{ item.qty }}</span>
            <span>â‚¹{{ (item.menuItem.price * item.qty).toFixed(2) }}</span>
          </div>

          <!-- Delivery Fee Line -->
          <div *ngIf="form.get('orderType')?.value === 'DELIVERY'" class="item-line fee-line">
            <span>ğŸšš Delivery Fee</span>
            <span *ngIf="deliveryFee > 0">â‚¹{{ deliveryFee }}</span>
            <span *ngIf="deliveryFee === 0" class="text-success">FREE</span>
          </div>
        </div>
        <div class="summary-total">
          <span>Total Amount</span>
          <strong>â‚¹{{ total.toFixed(2) }}</strong>
        </div>
      </div>

      <!-- Submit Button -->
      <!-- Submit Button (Wrapped for Sticky Footer) -->
      <div class="actions">
        <button type="submit" [disabled]="loading || form.invalid || cart.getCount() === 0" class="btn-submit">
          <span *ngIf="!loading">
            {{ (form.get('orderType')?.value === 'DINE_IN' || form.get('orderType')?.value === 'PICKUP') ? 'âœ… Place
            Order'
            : 'âœ… Place Order & Pay' }}
          </span>
          <span *ngIf="loading">â³ Processing...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- APPEND CONFIRMATION MODAL -->
<div class="checkout-overlay" *ngIf="showAppendPrompt && existingSessionOrder">
  <div class="modal-card">
    <h3>ğŸ‘‹ Welcome Back to Table {{ existingSessionOrder.tableNumber }}</h3>
    <p>We found an active order (#{{ existingSessionOrder.id }}) for <strong>{{ existingSessionOrder.customerName
        }}</strong>.</p>
    <p>Would you like to <strong>add these items</strong> to the existing order, or start a <strong>new order</strong>?
    </p>

    <div class="modal-actions">
      <button class="btn-join" (click)="confirmAppend()">
        â• Add to Order #{{ existingSessionOrder.id }}
      </button>
      <button class="btn-new" (click)="startNewOrder()">
        ğŸ†• Start New Order
      </button>
    </div>
  </div>
</div>