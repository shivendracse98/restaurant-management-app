<div class="history-container">
    <h2>üìú My Order History</h2>

    <div *ngIf="loading" class="loading-state">
        <p>Loading your orders...</p>
    </div>

    <ng-container *ngIf="orders$ | async as orders">
        <div *ngIf="!loading && orders.length === 0" class="empty-state">
            <p>No orders found.</p>
            <a routerLink="/menu" class="btn btn-primary">Start Ordering</a>
        </div>

        <div class="orders-list" *ngIf="orders.length > 0">
            <div *ngFor="let order of orders; let i = index" class="order-card">
                <div class="card-header">
                    <span class="order-id">Order #{{ i + 1 }}</span>
                    <span class="order-date">{{ order.createdAt | date:'medium' }}</span>
                </div>

                <div class="card-body">
                    <div class="items">
                        <div *ngFor="let item of order.items" class="item-row">
                            {{ item.qty }}x {{ item.name }}
                        </div>
                    </div>
                    <div class="total-section">
                        <span class="total-label">Total:</span>
                        <span class="total-amount">‚Çπ{{ order.total }}</span>
                    </div>
                </div>

                <div class="card-footer">
                    <span class="badge" [ngClass]="getStatusClass(order.status)">
                        {{ order.status }}
                    </span>
                    <div class="actions">
                        <button class="btn btn-sm btn-outline" *ngIf="order.status === 'DELIVERED'"
                            (click)="openRateModal(order)">
                            ‚≠ê Rate
                        </button>
                        <a [routerLink]="['/order-tracking', order.id]" class="btn btn-sm btn-outline">
                            Track ‚û°Ô∏è
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>

    <!-- RATING MODAL -->
    <!-- RATING MODAL -->
    <div class="modal-backdrop" *ngIf="showRateModal" (click)="closeRateModal()">
        <div class="modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3>Rate Order #{{ selectedOrder?.id }}</h3>
                <button class="close-btn" (click)="closeRateModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="star-rating-container">
                    <div class="stars">
                        <span *ngFor="let star of [1,2,3,4,5]" class="star-icon" [class.filled]="rating >= star"
                            (click)="rating = star" (mouseenter)="hoverRating = star" (mouseleave)="hoverRating = 0">
                            ‚òÖ
                        </span>
                    </div>
                    <div class="rating-label">
                        {{ getRatingLabel(hoverRating || rating) }}
                    </div>
                </div>

                <textarea [(ngModel)]="reviewComment" placeholder="How was the food? Tell us about your experience..."
                    rows="4"></textarea>

                <div class="modal-actions">
                    <button (click)="closeRateModal()">Cancel</button>
                    <button class="btn-primary" (click)="submitReview()" [disabled]="rating === 0">Submit
                        Review</button>
                </div>
            </div>
        </div>
    </div>
</div>