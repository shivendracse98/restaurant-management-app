<div class="staff-pos-container">
  <!-- Header -->
  <div class="header-row">
    <div style="display: flex; gap: 15px; align-items: center;">
      <h2>ğŸ‘¨â€ğŸ’¼ Staff POS</h2>
      <a routerLink="/staff/kitchen" class="btn secondary-btn"
        style="text-decoration: none; padding: 5px 10px; font-size: 0.9rem;">
        ğŸ‘¨â€ğŸ³ Kitchen View
      </a>
    </div>
    <div class="tab-buttons">
      <button class="tab-btn" [class.active]="activeTab === 'ORDER'" (click)="switchTab('ORDER')">
        ğŸ›’ Take Order
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'TIFFIN'" (click)="switchTab('TIFFIN')">
        ğŸ± Tiffin
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'ONGOING'" (click)="switchTab('ONGOING')">
        â³ Ongoing
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'ONLINE'" (click)="switchTab('ONLINE')">
        ğŸ”” Online Orders <span *ngIf="onlineOrders.length > 0" class="badge-count">{{ onlineOrders.length }}</span>
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'UNPAID'" (click)="switchTab('UNPAID')">
        ğŸ’³ Unpaid <span *ngIf="unpaidOrders.length > 0" class="badge-count" style="background:#c62828;">{{
          unpaidOrders.length }}</span>
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'REVENUE'" (click)="switchTab('REVENUE')">
        ğŸ“ Shift Summary
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'LEAVES'" (click)="switchTab('LEAVES')">
        ğŸ–ï¸ My Leaves
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'TODAY'" (click)="switchTab('TODAY')"
        style="background: #2d3436; color: white;">
        ğŸ“‹ Manage Orders
      </button>
    </div>
  </div>

  <!-- Message -->
  <div *ngIf="message" class="message">{{ message }}</div>

  <!-- ========== UNPAID ORDERS TAB ========== -->
  <div *ngIf="activeTab === 'UNPAID'" class="tab-content">
    <h3>ğŸ’³ Served & Unpaid Orders</h3>
    <div class="table-wrapper">
      <table class="orders-table" *ngIf="unpaidOrders.length > 0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of unpaidOrders">
            <td>#{{ o.id }}</td>
            <td>
              {{ o.customerName || 'Guest' }}<br>
              <small>{{ o.customerPhone }}</small>
            </td>
            <td>{{ o.items?.length || 0 }} items</td>
            <td style="color: #c62828; font-weight: bold;">â‚¹{{ o.totalAmount || o.total }}</td>
            <td>
              <span class="badge badge-delivered">SERVED / UNPAID</span>
            </td>
            <td>
              <button class="btn share-btn" style="margin-right: 5px; background-color: #3498DB; color: white;"
                (click)="shareBill(o)" title="View & Share Bill">
                <i class="fa fa-file-text-o"></i> Bill
              </button>
              <button class="btn primary-btn" style="background-color: #E67E22; border-color: #E67E22;"
                (click)="openPayment(o)">
                ğŸ’° Collect Payment
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <p *ngIf="unpaidOrders.length === 0" class="no-data">No unpaid orders! All clear. ğŸ‰</p>
  </div>

  <!-- ========== TODAY'S ORDERS (MANAGE DELIVERY) TAB ========== -->
  <div *ngIf="activeTab === 'TODAY'" class="tab-content" style="padding: 0;">
    <!-- Embedding the Staff Today Orders Component -->
    <app-staff-today-orders></app-staff-today-orders>
  </div>

  <!-- ========== TAKE ORDER TAB ========== -->
  <div *ngIf="activeTab === 'ORDER'" class="pos-layout">
    <app-pos-order-taking [menuItems]="menuItems" [orderForm]="orderForm" [isLoading]="isLoading"
      [isManageMode]="isManageMode" (placeOrderTrigger)="toggleCart()" (addToCart)="addItem($event)"
      (toggleStock)="addItem($event)" (removeFromCartInput)="removeItemFromOrder($event)"
      (clearCartTrigger)="clearCart()">
    </app-pos-order-taking>

    <!-- CART MODAL (Kept in Parent as it manages the Form + Submission Logic) -->
    <div class="modal-backdrop" *ngIf="showCartModal" (click)="toggleCart()">
      <div class="modal cart-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>ğŸ›’ Current Order</h3>
          <button class="close-btn" (click)="toggleCart()">âœ•</button>
        </div>

        <div class="modal-body">
          <form [formGroup]="orderForm" class="order-form">
            <div class="form-row two-col">
              <div>
                <label>Table # <span *ngIf="orderForm.get('orderType')?.value === 'DINE_IN'"
                    style="color:red">*</span></label>
                <input type="number" formControlName="tableNumber" placeholder="0 = Standing" class="highlight-input" />
                <small style="color: #888; display: block; margin-top: 2px; font-size: 0.75rem;">
                  (0: Walk-in, >0: Append)
                </small>
              </div>
              <div>
                <label>Type</label>
                <select formControlName="orderType">
                  <option value="DINE_IN">Dine In</option>
                  <option value="TAKEAWAY">Takeaway</option>
                  @if (featureFlagStore.isFeatureEnabled('DELIVERY_MANAGEMENT')) {
                  <option value="DELIVERY">Delivery ğŸšš</option>
                  }
                </select>
              </div>
            </div>

            <!-- Conditional Address for Delivery -->
            <div class="form-row two-col" *ngIf="orderForm.get('orderType')?.value === 'DELIVERY'">
              <div>
                <label>Delivery Address <span style="color:red">*</span></label>
                <textarea formControlName="address" rows="1" placeholder="Address..."></textarea>
              </div>
              <div>
                <label>Pincode <span style="color:red">*</span></label>
                <input type="text" formControlName="pincode" placeholder="e.g. 560001" />
              </div>
            </div>

            <div class="form-row">
              <label>Customer Name</label>
              <input type="text" formControlName="customerName" placeholder="Guest Name" />
            </div>

            <div class="cart-items-list">
              <div *ngFor="let item of cartItems; let i = index" class="cart-item">
                <div class="item-name">{{ item.name }}</div>
                <div class="item-price">â‚¹{{ item.price }}</div>
                <button class="remove-btn" (click)="removeItemFromOrder(i)">ğŸ—‘ï¸</button>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <div class="grand-total">Total: â‚¹{{ getTotal(cartItems) }}</div>
          <button class="btn clear-btn" (click)="clearCart(); toggleCart()">Clear</button>
          <button class="btn place-order-btn" (click)="placeOrder()"
            [disabled]="!orderForm.valid || cartItems.length === 0 || isLoading">
            {{ isLoading ? 'â³ Processing...' : 'âœ… Place Order' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ONLINE ORDERS (VERIFICATION) TAB ========== -->
  <div *ngIf="activeTab === 'ONLINE'" class="tab-content">
    <h3>ğŸ”” Online Verification Queue</h3>
    <div class="table-wrapper">
      <table class="orders-table" *ngIf="onlineOrders.length > 0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of onlineOrders">
            <td>#{{ o.id }}</td>
            <td>{{ o.customerName || 'Guest' }}<br><small>{{ o.customerPhone }}</small></td>
            <td>{{ o.items?.length }} items</td>
            <td>â‚¹{{ o.total }}</td>
            <td>
              <div *ngIf="o.paymentStatus === 'VERIFICATION_PENDING'" style="color:orange; font-weight:bold;">âš  Proof
                Uploaded</div>
              <div *ngIf="o.paymentMode === 'CASH' && o.status === 'PENDING'" style="color:blue; font-weight:bold;">ğŸ’µ
                Pay
                at Counter</div>
              <div *ngIf="o.paymentProof" style="font-size:0.8em;">Ref: {{ o.paymentProof }}</div>
            </td>
            <td>
              <button class="btn primary-btn" style="background-color: #27AE60;" (click)="verifyPayment(o)">
                âœ… Verify & Accept
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <p *ngIf="onlineOrders.length === 0" class="no-data">No pending online orders! ğŸ‰</p>
  </div>

  <!-- ========== TIFFIN TAB ========== -->
  <div *ngIf="activeTab === 'TIFFIN'" class="tab-content">
    <app-pos-tiffin [menuItems]="menuItems" [subscriptions]="subscriptionsList" [isLoading]="isLoading"
      (createSubscription)="createSubscription($event)" (toggleStatus)="toggleSubscriptionStatus($event)">
    </app-pos-tiffin>
  </div>

  <!-- ========== ONGOING ORDERS TAB ========== -->
  <div *ngIf="activeTab === 'ONGOING'" class="tab-content">
    <app-pos-ongoing-orders [ongoingOrders]="ongoingOrders" [isLoading]="isLoading"
      (verifyPayment)="verifyPayment($event)" (markAsServed)="markAsServed($event)" (openPayment)="openPayment($event)"
      (shareBill)="shareBill($event)" (openEdit)="openEdit($event)">
    </app-pos-ongoing-orders>
  </div>

  <!-- ========== SHIFT SUMMARY TAB ========== -->
  <div *ngIf="activeTab === 'REVENUE'" class="tab-content revenue-tab">
    <h3>ğŸ“ Shift Summary (Today)</h3>

    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-label">Total Orders</div>
        <div class="stat-value">{{ todayOrders.length }}</div>
      </div>
      <!-- Modified for Staff Privacy: Count only, no Revenue Amount -->
      <div class="stat-box">
        <div class="stat-label">Cash Orders</div>
        <div class="stat-value">{{ getCashOrdersCount() }}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Online/UPI Orders</div>
        <div class="stat-value">{{ getOnlineOrdersCount() }}</div>
      </div>
    </div>

    <!-- Chart hidden for Staff as per privacy policy -->
    <!-- <div class="chart-container" *ngIf="revenueChartData && revenueChartOptions">
      <canvas baseChart [data]="revenueChartData" [options]="revenueChartOptions" type="bar"></canvas>
    </div> -->

    <div class="table-wrapper">
      <table class="orders-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of todayOrders">
            <td>#{{ o.id }}</td>
            <td>{{ o.customerName }}</td>
            <td>{{ o.items?.length || 0 }} items</td>
            <td>â‚¹{{ o.total }}</td>
            <td><span class="badge">{{ o.status }}</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ========== LEAVES TAB ========== -->
  <div *ngIf="activeTab === 'LEAVES'" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3>ğŸ–ï¸ My Leave History</h3>
      <button class="btn primary-btn" (click)="openLeaveModal()">+ Apply for Leave</button>
    </div>

    <div class="table-wrapper">
      <table class="orders-table">
        <thead>
          <tr>
            <th>DateApplied</th>
            <th>Period</th>
            <th>Days</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Admin Note</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let l of myLeaves">
            <td>#{{ l.id }}</td>
            <td>{{ l.startDate }} to {{ l.endDate }}</td>
            <td>
              {{ getLeaveDuration(l.startDate, l.endDate) }} Days
            </td>
            <td>{{ l.reason }}</td>
            <td>
              <span class="badge" [class.badge-ready]="l.status === 'APPROVED'"
                [class.badge-pending]="l.status === 'PENDING'"
                [style.background-color]="l.status === 'REJECTED' ? '#ffebee' : ''"
                [style.color]="l.status === 'REJECTED' ? '#c62828' : ''">
                {{ l.status }}
              </span>
            </td>
            <td>{{ l.adminComments || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <p *ngIf="myLeaves.length === 0" class="no-data">No leave applications yet.</p>
  </div>

  <!-- LEAVE APPLICATION MODAL -->
  <div class="modal-backdrop" *ngIf="showLeaveModal" (click)="closeLeaveModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ–ï¸ Apply for Leave</h3>
        <button class="close-btn" (click)="closeLeaveModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="leaveForm" (ngSubmit)="applyForLeave()">
          <div class="form-row">
            <label>Start Date</label>
            <input type="date" formControlName="startDate">
          </div>
          <div class="form-row">
            <label>End Date</label>
            <input type="date" formControlName="endDate">
          </div>
          <div class="form-row">
            <label>Reason</label>
            <textarea formControlName="reason" rows="3" placeholder="e.g. Family Function"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" (click)="closeLeaveModal()">Cancel</button>
            <button type="submit" class="btn primary-btn" [disabled]="leaveForm.invalid || isLoading">Submit
              Application</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ========== EDIT ORDER MODAL ========== -->
  <div *ngIf="showEditModal && editOrder" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Edit Order #{{ editOrder.id }}</h3>
        <button class="close-btn" (click)="closeEdit()">âœ•</button>
      </div>

      <div class="modal-body">
        <!-- Add Items Grid -->
        <h4>Add Items</h4>
        <div class="menu-grid-small">
          <div class="menu-item-small" *ngFor="let item of filteredMenu">
            <img [src]="item.imageUrl" [alt]="item.name" />
            <div class="item-info-small">
              <div class="item-name-small">{{ item.name }}</div>
              <div class="item-price-small">â‚¹{{ item.price }}</div>
              <button class="btn" (click)="addItemToEdit(item)">+ Add</button>
            </div>
          </div>
        </div>

        <!-- Edit Items -->
        <h4>Order Items</h4>
        <div class="edit-items">
          <div *ngFor="let item of editOrder.items; let i = index" class="edit-item">
            <div class="edit-item-info">
              <div class="edit-item-name">{{ item.name }}</div>
              <div class="edit-item-price">â‚¹{{ item.price }}</div>
            </div>

            <div class="qty-control">
              <button class="qty-btn" (click)="decreaseQty(item)">âˆ’</button>
              <span class="qty">{{ item.qty }}</span>
              <button class="qty-btn" (click)="increaseQty(item)">+</button>
            </div>

            <button class="remove-btn" (click)="removeItemFromEdit(i)">Remove</button>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" (click)="closeEdit()">Cancel</button>
        <button class="btn primary-btn" (click)="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>


  <!-- Payment Modal -->
  <div class="modal-backdrop" *ngIf="showPaymentModal" (click)="closePayment()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 *ngIf="!pendingTiffinPayload">ğŸ’° Confirm Payment</h3>
        <h3 *ngIf="pendingTiffinPayload">ğŸ± Start Subscription</h3>
        <button class="close-btn" (click)="closePayment()">&times;</button>
      </div>
      <div class="modal-body">
        <h4>{{ pendingTiffinPayload ? 'Subscription Total:' : 'Total Amount:' }} <span
            style="color: #27AE60; font-size: 1.2rem;">â‚¹{{ payOrder?.totalAmount || payOrder?.total
            }}</span></h4>

        <!-- QR Code Section -->
        <div *ngIf="paymentMode === 'UPI' && paymentConfig?.upiQrImageUrl" style="text-align: center; margin: 1rem 0;">
          <img [src]="paymentConfig?.upiQrImageUrl" alt="Scan to Pay"
            style="width: 150px; height: 150px; border: 2px solid #27AE60; padding: 5px; border-radius: 10px;">
          <div style="margin-top: 5px; font-weight: 600; color: #555;">{{ paymentConfig?.upiId }}</div>
        </div>

        <div class="form-row" style="margin-top: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Select Payment Mode:</label>
          <div class="payment-options" style="display: flex; gap: 1rem;">
            <button class="btn" [class.active-mode]="paymentMode === 'CASH'" (click)="paymentMode = 'CASH'"
              style="flex: 1; border: 2px solid #ddd; background: white; color: #333;">
              ğŸ’µ Cash
            </button>
            <button class="btn" [class.active-mode]="paymentMode === 'UPI'" (click)="paymentMode = 'UPI'"
              style="flex: 1; border: 2px solid #ddd; background: white; color: #333;">
              ğŸ“± UPI / Online
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="closePayment()">Cancel</button>
        <button class="btn primary-btn" (click)="confirmPayment()">
          {{ pendingTiffinPayload ? 'Pay & Create' : 'Confirm Payment' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Bill / Share Modal -->
  <div class="modal-backdrop" *ngIf="showBillModal && viewBillOrder" (click)="closeBillModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ§¾ Order Summary #{{ viewBillOrder.id }}</h3>
        <button class="close-btn" (click)="closeBillModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="bill-details"
          style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace;">
          <div style="border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px;">
            <strong>Customer:</strong> {{ viewBillOrder.customerName }}<br>
            <strong>Phone:</strong> {{ viewBillOrder.customerPhone }}<br>
            <strong>Date:</strong> {{ viewBillOrder.createdAt | date:'short' }}
          </div>
          <div *ngFor="let item of viewBillOrder.items"
            style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>{{ item.qty }}x {{ item.name }}</span>
            <span>â‚¹{{ item.price * item.qty }}</span>
          </div>
          <div
            style="border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em;">
            <span>TOTAL</span>
            <span>â‚¹{{ viewBillOrder.total }}</span>
          </div>
        </div>

        <h4 style="margin-bottom: 10px;">Share Bill via:</h4>
        <div class="payment-options" style="display: flex; gap: 1rem;">
          <button class="btn" style="flex: 1; background: #25D366; color: white;" (click)="confirmShare('WHATSAPP')">
            <i class="fa fa-whatsapp"></i> WhatsApp
          </button>
          <button class="btn" style="flex: 1; background: #3498DB; color: white;" (click)="confirmShare('SMS')">
            <i class="fa fa-commenting-o"></i> SMS / Text
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- CONFLICT MODAL (Shared Table) -->
  <div class="modal-backdrop" *ngIf="showConflictModal" (click)="closeConflictModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>âš ï¸ Table Occupied</h3>
        <button class="close-btn" (click)="closeConflictModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p>This table already has active orders. What would you like to do?</p>

        <div class="existing-orders-list" style="margin: 15px 0;">
          <div *ngFor="let ord of conflictOrders"
            style="background: #fff3e0; padding: 10px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #ffe0b2; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>{{ ord.customerName || 'Guest' }}</strong>
              <div style="font-size: 0.85em; color: #666;">#{{ ord.id }} â€¢ {{ ord.items?.length }} items</div>
            </div>
            <button class="btn secondary-btn" (click)="confirmAppend(ord)">
              Append Items
            </button>
          </div>
        </div>

        <div style="text-align: center; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px;">
          <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">Or start a fresh bill for a new customer?</p>
          <button class="btn primary-btn" style="width: 100%;" (click)="confirmNewBill()">
            âœ¨ Start New Separate Bill
          </button>
        </div>
      </div>
    </div>
  </div>
</div>