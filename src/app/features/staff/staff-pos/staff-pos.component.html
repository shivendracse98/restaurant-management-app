<div class="staff-pos-container">
  <!-- HEADER ROW -->
  <div class="header-row">
    <div>
      <h2>
        <span>üçΩÔ∏è</span>
        Staff POS
      </h2>
    </div>

    <a routerLink="/staff/kitchen" class="kitchen-link" aria-label="Go to Kitchen Management">
      üî• Kitchen
    </a>

    <!-- TAB BUTTONS -->
    <div class="tab-buttons">
      <button *ngFor="let tab of ['ORDER', 'TIFFIN', 'ONGOING', 'REVENUE', 'ONLINE', 'LEAVES', 'UNPAID', 'TODAY']"
        class="tab-btn" [class.active]="activeTab === tab" (click)="activeTab = $any(tab)"
        [attr.aria-label]="'Switch to ' + tab + ' tab'" [attr.aria-pressed]="activeTab === tab">
        {{ tab }}
        <span *ngIf="tab === 'UNPAID' && unpaidOrders.length > 0" class="badge-count">
          {{ unpaidOrders.length }}
        </span>
        <span *ngIf="tab === 'ONLINE' && onlineOrders.length > 0" class="badge-count">
          {{ onlineOrders.length }}
        </span>
        <span *ngIf="tab === 'ONGOING' && ongoingOrders.length > 0" class="badge-count">
          {{ ongoingOrders.length }}
        </span>
      </button>
    </div>
  </div>

  <!-- SUCCESS MESSAGE -->
  <div *ngIf="message" class="message" role="status" aria-live="polite">
    {{ message }}
  </div>

  <!-- POS LAYOUT -->
  <div class="pos-layout">
    <!-- ===== ORDER TAB ===== -->
    <app-pos-order-taking *ngIf="activeTab === TabType.ORDER" [menuItems]="menuItems" [orderForm]="orderForm"
      [isLoading]="isLoading" [isManageMode]="isManageMode" (addToCart)="addItem($event)"
      (removeFromCartInput)="removeItemFromOrder($event)" (clearCartTrigger)="clearCart()"
      (placeOrderTrigger)="placeOrder()" (toggleStock)="toggleItemAvailability($event)">
    </app-pos-order-taking>

    <!-- ===== TIFFIN TAB ===== -->
    <app-pos-tiffin *ngIf="activeTab === TabType.TIFFIN" [subscriptions]="subscriptionsList" [menuItems]="menuItems"
      (createSubscription)="createSubscription($event)" (toggleStatus)="toggleSubscriptionStatus($event)">
    </app-pos-tiffin>

    <!-- ===== ONGOING ORDERS TAB ===== -->
    <app-pos-ongoing-orders *ngIf="activeTab === TabType.ONGOING" [ongoingOrders]="ongoingOrders"
      (openEdit)="openEdit($event)" (verifyPayment)="verifyPayment($event)" (openPayment)="openPayment($event)"
      (shareBill)="shareBill($event)" (markAsServed)="markOrderServed($event)">
    </app-pos-ongoing-orders>

    <!-- ===== REVENUE TAB ===== -->
    <div *ngIf="activeTab === TabType.REVENUE" class="tab-content revenue-tab">
      <h3>üìä Revenue Dashboard</h3>

      <div class="stats-row">
        <div class="stat-box">
          <div class="stat-label">Today's Revenue</div>
          <div class="stat-value">‚Çπ{{ getTodayRevenueTotal() | number }}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Cash Orders</div>
          <div class="stat-value">{{ getCashOrdersCount() }}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Online Orders</div>
          <div class="stat-value">{{ getOnlineOrdersCount() }}</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Total Orders</div>
          <div class="stat-value">{{ todayOrders.length }}</div>
        </div>
      </div>

      <!-- Revenue Chart -->
      <div style="height: 300px; position: relative">
        <canvas class="revenue-chart" *ngIf="revenueChartData.datasets && revenueChartData.datasets.length > 0"
          baseChart [data]="revenueChartData" [options]="revenueChartOptions" type="bar"
          aria-label="Last 7 days revenue chart">
        </canvas>
      </div>

      <!-- Orders Table -->
      <div class="table-wrapper" *ngIf="todayOrders.length > 0">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Payment</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of todayOrders">
              <td>#{{ order.id }}</td>
              <td>{{ order.customerName || 'Guest' }} <br /> {{ order.customerPhone }}</td>
              <td>{{ order.items.length || 0 }} items</td>
              <td>‚Çπ{{ order.total || order.totalAmount | number }}</td>
              <td>
                <span [ngSwitch]="order.status" class="badge"
                  [class.badge-pending]="order.status === OrderStatus.PENDING"
                  [class.badge-ready]="order.status === OrderStatus.READY"
                  [class.badge-delivered]="order.status === OrderStatus.DELIVERED">
                  {{ order.status }}
                </span>
              </td>
              <td>
                <span [ngSwitch]="order.paymentMode" class="badge"
                  [class.badge-cash]="order.paymentMode === PaymentMode.CASH"
                  [class.badge-upi]="order.paymentMode === PaymentMode.UPI">
                  {{ order.paymentMode }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="todayOrders.length === 0" class="no-data">
        No orders yet today. üéØ
      </div>
    </div>

    <!-- ===== ONLINE ORDERS (PENDING PAYMENT) TAB ===== -->
    <div *ngIf="activeTab === TabType.ONLINE" class="tab-content">
      <h3>üí≥ Online Orders (Pending Verification)</h3>

      <div class="table-wrapper" *ngIf="onlineOrders.length > 0">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Payment Status</th>
              <th>Proof</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of onlineOrders">
              <td>#{{ order.id }}</td>
              <td>{{ order.customerName || 'Guest' }} <br /> {{ order.customerPhone }}</td>
              <td>{{ order.items.length || 0 }} items</td>
              <td>‚Çπ{{ order.total || order.totalAmount | number }}</td>
              <td>
                <span class="badge badge-pending">
                  ‚ö†Ô∏è Awaiting Verification
                </span>
              </td>
              <td>
                <span *ngIf="order.paymentProof" class="badge-pending">
                  üíµ Proof: {{ order.paymentProof }}
                </span>
                <span *ngIf="!order.paymentProof">‚Äî</span>
              </td>
              <td>
                <button class="btn primary-btn" (click)="verifyPayment(order)" [disabled]="isLoading"
                  [attr.aria-label]="'Verify payment for order ' + order.id">
                  ‚úÖ Verify
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="onlineOrders.length === 0" class="no-data">
        No pending online orders! üéâ
      </div>
    </div>

    <!-- ===== LEAVES TAB ===== -->
    <div *ngIf="activeTab === TabType.LEAVES" class="tab-content">
      <h3>üèñÔ∏è Leave Requests</h3>

      <button class="btn primary-btn" (click)="showLeaveModal = !showLeaveModal" aria-label="Request leave">
        + Request Leave
      </button>

      <div class="table-wrapper" *ngIf="myLeaves.length > 0">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Date Applied</th>
              <th>Period</th>
              <th>Days</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Admin Note</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let leave of myLeaves">
              <td>{{ leave.createdAt | date: 'dd/MM/yyyy' }}</td>
              <td>{{ leave.startDate | date: 'dd MMM' }} to {{ leave.endDate | date: 'dd MMM' }}</td>
              <td>{{ getLeaveDuration(leave.startDate, leave.endDate) }} days</td>
              <td>{{ leave.reason }}</td>
              <td>
                <span class="badge" [class.badge-pending]="leave.status === 'PENDING'"
                  [class.badge-ready]="leave.status === 'APPROVED'" [class.badge-error]="leave.status === 'REJECTED'">
                  {{ leave.status }}
                </span>
              </td>
              <td>{{ leave.adminComments || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="myLeaves.length === 0" class="no-data">
        No leave applications yet.
      </div>
    </div>

    <!-- ===== UNPAID ORDERS TAB ===== -->
    <div *ngIf="activeTab === TabType.UNPAID" class="tab-content">
      <h3>üí∞ Unpaid Orders (Served)</h3>

      <div class="table-wrapper" *ngIf="unpaidOrders.length > 0">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let order of unpaidOrders">
              <td>#{{ order.id }}</td>
              <td>
                {{ order.customerName || 'Guest' }}
                <br />
                {{ order.customerPhone }}
              </td>
              <td>{{ order.items.length || 0 }} items</td>
              <td>‚Çπ{{ order.total || order.totalAmount | number }}</td>
              <td>
                <span class="badge badge-delivered">
                  SERVED / UNPAID
                </span>
              </td>
              <td>
                <button class="btn primary-btn" (click)="openPayment(order)" [disabled]="isLoading"
                  [attr.aria-label]="'Collect payment for order ' + order.id">
                  üíµ Collect
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="unpaidOrders.length === 0" class="no-data">
        No unpaid orders! All clear. üéâ
      </div>
    </div>

    <!-- ===== TODAY'S ORDERS TAB ===== -->
    <app-staff-today-orders *ngIf="activeTab === TabType.TODAY">
    </app-staff-today-orders>
  </div>

  <!-- ===== FLOATING CART ===== -->
  <div *ngIf="activeTab === TabType.ORDER && cartItems.length > 0" class="fab-cart-bar" (click)="toggleCart()"
    role="button" tabindex="0" (keydown.enter)="toggleCart()" (keydown.space)="toggleCart()"
    [attr.aria-label]="'View cart with ' + cartItems.length + ' items'">
    <div class="fab-info">
      <span>üõí {{ cartItems.length }} items</span>
      <span class="pipe">|</span>
      <span class="total">‚Çπ{{ getTotal(cartItems) | number }}</span>
    </div>
    <div class="fab-action">View Cart ‚Üí</div>
  </div>

  <!-- ===== CART MODAL (ENTERPRISE) ===== -->
  <div *ngIf="showCartModal" class="modal-backdrop" role="dialog" aria-modal="true" (click)="toggleCart()">
    <div class="modal cart-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üõí Current Order</h3>
        <button class="close-btn" (click)="toggleCart()" aria-label="Close cart">‚úï</button>
      </div>

      <div class="modal-body">
        <form [formGroup]="orderForm" class="order-form">
          <!-- Order Settings Row -->
          <div class="form-row two-col">
            <div>
              <label>Order Type</label>
              <select formControlName="orderType">
                <option value="DINE_IN">üçΩÔ∏è Dine In</option>
                <option value="TAKEAWAY">üõçÔ∏è Takeaway</option>
                <option value="DELIVERY">üöö Delivery</option>
              </select>
            </div>
            <div>
              <label>Table # <span *ngIf="orderForm.value.orderType === 'DINE_IN'" style="color:red">*</span></label>
              <input type="number" formControlName="tableNumber" placeholder="0 for Counter/Standing"
                [class.highlight-input]="orderForm.value.orderType === 'DINE_IN'" />
              <small style="color: #666; font-size: 0.8rem;">(Required for Dine In)</small>
            </div>
          </div>

          <!-- Customer Info -->
          <div class="form-row two-col">
            <div>
              <label>Customer Name <span style="color:red">*</span></label>
              <input type="text" formControlName="customerName" placeholder="Guest Name" />
            </div>
            <div>
              <label>Phone (Optional)</label>
              <input type="text" formControlName="customerPhone" placeholder="Mobile Number" maxlength="10" />
            </div>
          </div>

          <!-- Conditional Delivery Address -->
          <div class="form-row two-col" *ngIf="orderForm.value.orderType === 'DELIVERY'">
            <div>
              <label>Delivery Address <span style="color:red">*</span></label>
              <textarea formControlName="address" rows="1" placeholder="Full Address"></textarea>
            </div>
            <div>
              <label>Pincode <span style="color:red">*</span></label>
              <input type="text" formControlName="pincode" placeholder="e.g. 560001" />
            </div>
          </div>

          <!-- Cart Items List -->
          <h4 style="margin: 1rem 0 0.5rem; color: #E67E22; border-bottom: 1px solid #eee; padding-bottom: 5px;">Items
          </h4>
          <div class="cart-items-list" *ngIf="cartItems.length > 0; else emptyCart">
            <div *ngFor="let item of cartItems; let i = index" class="cart-item">
              <div class="item-info">
                <div class="item-name">{{ item.name }}</div>
                <div class="item-price">‚Çπ{{ item.price }}</div>
              </div>
              <button class="btn-icon delete-btn" (click)="removeItemFromOrder(i)" aria-label="Remove item">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <ng-template #emptyCart>
            <div class="empty-state">Cart is empty. Add items from the menu!</div>
          </ng-template>

          <!-- Total Calculation -->
          <!-- Total Calculation -->
          <div class="cart-total-breakdown" *ngIf="cartItems.length > 0"
            style="margin-top: 20px; border-top: 2px dashed #eee; padding-top: 10px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span style="color: #666;">Subtotal:</span>
              <span>‚Çπ{{ getCartSubtotal(cartItems) | number:'1.2-2' }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #666;">
              <span>GST (CGST + SGST):</span>
              <span>+ ‚Çπ{{ getCartTax(cartItems).totalTax | number:'1.2-2' }}</span>
            </div>
            <div class="cart-total"
              style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; margin-top: 10px; color: #2C3E50;">
              <span>Total To Pay:</span>
              <span>‚Çπ{{ getCartGrandTotal(cartItems) | number:'1.2-2' }}</span>
            </div>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button class="btn secondary-btn" (click)="clearCart()" [disabled]="cartItems.length === 0">
          Clear
        </button>
        <button class="btn primary-btn" (click)="placeOrder()"
          [disabled]="!orderForm.valid || cartItems.length === 0 || isLoading">
          {{ isLoading ? '‚è≥ Processing...' : '‚úÖ Place Order' }}
        </button>
      </div>
    </div>
  </div>

  <!-- ===== CONFLICT MODAL ===== -->
  <div *ngIf="showConflictModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" style="max-width: 600px">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Table Already Has Active Orders</h3>
        <button class="close-btn" (click)="closeConflictModal()" aria-label="Close dialog">
          ‚úï
        </button>
      </div>

      <div class="modal-body">
        <p>Table #{{ orderForm.value.tableNumber }} has the following active order(s):</p>

        <div *ngFor="let order of conflictOrders"
          style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 6px">
          <strong>Order #{{ order.id }}</strong>
          <p>Status: {{ order.status }}</p>
          <p>Items: {{ order.items.length || 0 }}</p>
          <p>Total: ‚Çπ{{ order.total || order.totalAmount }}</p>
        </div>

        <p style="margin-top: 20px; font-weight: 600; color: #E67E22;">What would you like to do?</p>
      </div>

      <div class="modal-footer">
        <button class="btn secondary-btn" (click)="closeConflictModal()" aria-label="Close without action">
          Cancel
        </button>
        <button class="btn primary-btn" (click)="confirmNewBill()" aria-label="Start a new bill for this table">
          Start New Bill
        </button>
        <button *ngIf="conflictOrders.length === 1" class="btn primary-btn" (click)="confirmAppend(conflictOrders[0])"
          aria-label="Add items to existing order">
          Add to Order #{{ conflictOrders[0].id }}
        </button>
      </div>
    </div>
  </div>

  <!-- ===== BILL MODAL ===== -->
  <div *ngIf="showBillModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal cart-modal">
      <div class="modal-header">
        <h3>üßæ Share Bill - Order #{{ viewBillOrder?.id }}</h3>
        <button class="close-btn" (click)="closeBillModal()" aria-label="Close bill modal">
          ‚úï
        </button>
      </div>

      <div class="modal-body" *ngIf="viewBillOrder">
        <div style="margin-bottom: 15px">
          <strong>Customer:</strong> {{ viewBillOrder.customerName || 'Guest' }}
          <br />
          <strong>Phone:</strong> {{ viewBillOrder.customerPhone }}
          <br />
          <strong>Total:</strong>
          <div style="margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px;">
            <div style="display: flex; justify-content: space-between;">
              <span>Subtotal:</span>
              <span>‚Çπ{{ (viewBillOrder.subtotal || getOrderCalculatedSubtotal(viewBillOrder.items)) | number:'1.2-2'
                }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
              <span>Tax (CGST+SGST):</span>
              <span>‚Çπ{{ (viewBillOrder.taxAmount || 0) | number:'1.2-2' }}</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px;">
              <span>Grand Total:</span>
              <span>‚Çπ{{ (viewBillOrder.grandTotal || viewBillOrder.total || viewBillOrder.totalAmount) | number:'1.2-2'
                }}</span>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 20px">
          <strong>Items:</strong>
          <div class="cart-items-list">
            <div *ngFor="let item of viewBillOrder.items" class="cart-item">
              <div class="item-name">{{ item.name }}</div>
              <div>
                <span class="item-price">‚Çπ{{ item.price }}</span>
                <span style="color: #999">x{{ item.qty || 1 }}</span>
              </div>
            </div>
          </div>
        </div>

        <div style="padding: 10px; background: #f5f5f5; border-radius: 6px; margin-bottom: 15px">
          <strong>Share via:</strong>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn secondary-btn" (click)="closeBillModal()" aria-label="Close modal">
          Cancel
        </button>
        <button class="btn btn-outline" (click)="printBill(viewBillOrder!)" aria-label="Print tax invoice"
          style="margin-right: auto;border: 1px solid #ccc;">
          üñ®Ô∏è Print Bill
        </button>
        <button class="btn primary-btn" (click)="confirmShare('WHATSAPP')" aria-label="Share via WhatsApp">
          üì± WhatsApp
        </button>
        <button class="btn primary-btn" (click)="confirmShare('SMS')" aria-label="Share via SMS">
          üí¨ SMS
        </button>
      </div>
    </div>
  </div>

  <!-- ===== LEAVE APPLICATION MODAL ===== -->
  <div class="modal-backdrop" *ngIf="showLeaveModal" (click)="showLeaveModal = false">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üèñÔ∏è Apply for Leave</h3>
        <button class="close-btn" (click)="showLeaveModal = false">√ó</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="leaveForm" (ngSubmit)="applyForLeave()">
          <div class="form-row">
            <label>Start Date</label>
            <input type="date" formControlName="startDate">
          </div>
          <div class="form-row">
            <label>End Date</label>
            <input type="date" formControlName="endDate">
          </div>
          <div class="form-row">
            <label>Reason</label>
            <textarea formControlName="reason" rows="3" placeholder="e.g. Family Function"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" (click)="showLeaveModal = false">Cancel</button>
            <button type="submit" class="btn primary-btn" [disabled]="leaveForm.invalid || isLoading">Submit
              Application</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===== PAYMENT MODAL ===== -->
  <div class="modal-backdrop" *ngIf="showPaymentModal" (click)="closePayment()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 *ngIf="!pendingTiffinPayload">üí∞ Confirm Payment</h3>
        <h3 *ngIf="pendingTiffinPayload">üç± Start Subscription</h3>
        <button class="close-btn" (click)="closePayment()">&times;</button>
      </div>
      <div class="modal-body">
        <h4>{{ pendingTiffinPayload ? 'Subscription Total:' : 'Total Amount:' }} <span
            style="color: #27AE60; font-size: 1.2rem;">‚Çπ{{ payOrder?.totalAmount || payOrder?.total ||
            pendingTiffinPayload?.finalAmount
            }}</span></h4>

        <!-- QR Code Section -->
        <div *ngIf="paymentMode === PaymentMode.UPI && paymentConfig?.upiQrImageUrl"
          style="text-align: center; margin: 1rem 0;">
          <img [src]="paymentConfig?.upiQrImageUrl" alt="Scan to Pay"
            style="width: 150px; height: 150px; border: 2px solid #27AE60; padding: 5px; border-radius: 10px;">
          <div style="margin-top: 5px; font-weight: 600; color: #555;">{{ paymentConfig?.upiId }}</div>
        </div>

        <div class="form-row" style="margin-top: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Select Payment Mode:</label>
          <div class="payment-options" style="display: flex; gap: 1rem;">
            <button class="btn" [class.active-mode]="paymentMode === PaymentMode.CASH"
              (click)="paymentMode = PaymentMode.CASH"
              style="flex: 1; border: 2px solid #ddd; background: white; color: #333;">
              üíµ Cash
            </button>
            <button class="btn" [class.active-mode]="paymentMode === PaymentMode.UPI"
              (click)="paymentMode = PaymentMode.UPI"
              style="flex: 1; border: 2px solid #ddd; background: white; color: #333;">
              üì± UPI / Online
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="closePayment()">Cancel</button>
        <button class="btn primary-btn" (click)="confirmPayment()">
          {{ pendingTiffinPayload ? 'Pay & Create' : 'Confirm Payment' }}
        </button>
      </div>
    </div>
  </div>

</div>