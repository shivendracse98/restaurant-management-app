<div class="staff-pos-container">
  <!-- Header -->
  <div class="header-row">
    <div style="display: flex; gap: 15px; align-items: center;">
      <h2>üë®‚Äçüíº Staff POS</h2>
      <a routerLink="/staff/kitchen" class="btn secondary-btn"
        style="text-decoration: none; padding: 5px 10px; font-size: 0.9rem;">
        üë®‚Äçüç≥ Kitchen View
      </a>
    </div>
    <div class="tab-buttons">
      <button class="tab-btn" [class.active]="activeTab === 'ORDER'" (click)="switchTab('ORDER')">
        üõí Take Order
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'TIFFIN'" (click)="switchTab('TIFFIN')">
        üç± Tiffin
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'ONGOING'" (click)="switchTab('ONGOING')">
        ‚è≥ Ongoing
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'ONLINE'" (click)="switchTab('ONLINE')">
        üîî Online Orders <span *ngIf="onlineOrders.length > 0" class="badge-count">{{ onlineOrders.length }}</span>
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'REVENUE'" (click)="switchTab('REVENUE')">
        üìù Shift Summary
      </button>
    </div>
  </div>

  <!-- Message -->
  <div *ngIf="message" class="message">{{ message }}</div>

  <!-- ========== TAKE ORDER TAB ========== -->
  <div *ngIf="activeTab === 'ORDER'" class="pos-layout">
    <!-- ... content ... -->
    <!-- (Using existing structure indirectly by not replacing it, just ensuring context match) -->
    <!-- Wait, replacing larger block for safety -->
    <div class="menu-section">
      <div class="search-bar">
        <input type="text" [(ngModel)]="searchTerm" placeholder="üîç Search menu or category..." class="search-input" />
      </div>

      <div class="menu-grid">
        <div class="menu-item" *ngFor="let item of filteredMenu; trackBy: trackByItem">
          <img [src]="item.imageUrl" [alt]="item.name" />
          <div class="meta">
            <div class="name">{{ item.name }}</div>
            <div class="category">{{ item.category }}</div>
            <div class="price">‚Çπ{{ item.price }}</div>
          </div>
          <button class="btn add" (click)="addItem(item)">+ Add</button>
        </div>
      </div>
    </div>

    <!-- Right: Order Form & Cart (Sticky) -->
    <div class="cart-section">
      <!-- ... (Cart omitted for brevity in replace, but context is critical) ... -->
      <div class="cart-wrapper">
        <h3 class="cart-title">üìã Current Order</h3>
        <form [formGroup]="orderForm" class="order-form">
          <!-- Form fields -->
          <div class="form-row">
            <label>Customer Name</label>
            <input type="text" formControlName="customerName" placeholder="Walk-in Guest" />
          </div>
          <div class="form-row">
            <label>Phone</label>
            <input type="tel" formControlName="customerPhone" placeholder="0000000000" />
          </div>
          <div class="form-row">
            <label>Order Type</label>
            <select formControlName="orderType">
              <option value="DINE_IN">Dine In</option>
              <option value="TAKEAWAY">Takeaway</option>
              <option value="DELIVERY">Delivery</option>
            </select>
          </div>
          <div class="form-row">
            <label>Table #</label>
            <input type="text" formControlName="tableNumber" placeholder="Optional" />
          </div>
        </form>

        <div class="cart-items">
          <!-- Items -->
          <div *ngIf="cartItems.length === 0" class="empty-cart">
            üëâ Add items from menu ‚Üí
          </div>

          <div *ngFor="let item of cartItems; let i = index" class="cart-item">
            <div class="item-info">
              <div class="item-name">{{ item.name }}</div>
              <div class="item-price">‚Çπ{{ item.price }}</div>
            </div>
            <button class="remove-btn" (click)="removeItemFromOrder(i)">‚úï</button>
          </div>
        </div>
        <div class="cart-footer">
          <div class="total-section">
            <div class="total-label">Total</div>
            <div class="total-amount">‚Çπ{{ getTotal(cartItems) }}</div>
          </div>

          <button class="btn place-order-btn" (click)="placeOrder()" [disabled]="cartItems.length === 0 || isLoading">
            {{ isLoading ? '‚è≥ Placing...' : '‚úì Place Order' }}
          </button>

          <button class="btn clear-btn" (click)="clearCart()">Clear Cart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ONLINE ORDERS (VERIFICATION) TAB ========== -->
  <div *ngIf="activeTab === 'ONLINE'" class="tab-content">
    <h3>üîî Online Verification Queue</h3>
    <table class="orders-table" *ngIf="onlineOrders.length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of onlineOrders">
          <td>#{{ o.id }}</td>
          <td>{{ o.customerName || 'Guest' }}<br><small>{{ o.customerPhone }}</small></td>
          <td>{{ o.items?.length }} items</td>
          <td>‚Çπ{{ o.total }}</td>
          <td>
            <div *ngIf="o.paymentStatus === 'VERIFICATION_PENDING'" style="color:orange; font-weight:bold;">‚ö† Proof
              Uploaded</div>
            <div *ngIf="o.paymentMode === 'CASH' && o.status === 'PENDING'" style="color:blue; font-weight:bold;">üíµ Pay
              at Counter</div>
            <div *ngIf="o.paymentProof" style="font-size:0.8em;">Ref: {{ o.paymentProof }}</div>
          </td>
          <td>
            <button class="btn primary-btn" style="background-color: #27AE60;" (click)="verifyPayment(o)">
              ‚úÖ Verify & Accept
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="onlineOrders.length === 0" class="no-data">No pending online orders! üéâ</p>
  </div>

  <!-- ========== ONLINE ORDERS (VERIFICATION) TAB ========== -->
  <div *ngIf="activeTab === 'ONLINE'" class="tab-content">
    <h3>üîî Online Verification Queue</h3>
    <table class="orders-table" *ngIf="onlineOrders.length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of onlineOrders">
          <td>#{{ o.id }}</td>
          <td>{{ o.customerName || 'Guest' }}<br><small>{{ o.customerPhone }}</small></td>
          <td>{{ o.items?.length }} items</td>
          <td>‚Çπ{{ o.total }}</td>
          <td>
            <div *ngIf="o.paymentStatus === 'VERIFICATION_PENDING'" style="color:orange; font-weight:bold;">‚ö† Proof
              Uploaded</div>
            <div *ngIf="o.paymentMode === 'CASH' && o.status === 'PENDING'" style="color:blue; font-weight:bold;">üíµ Pay
              at Counter</div>
            <div *ngIf="o.paymentProof" style="font-size:0.8em;">Ref: {{ o.paymentProof }}</div>
          </td>
          <td>
            <button class="btn primary-btn" style="background-color: #27AE60;" (click)="verifyPayment(o)">
              ‚úÖ Verify & Accept
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="onlineOrders.length === 0" class="no-data">No pending online orders! üéâ</p>
  </div>

  <!-- ========== TIFFIN TAB ========== -->
  <div *ngIf="activeTab === 'TIFFIN'" class="tab-content">
    <h3>üç± Tiffin Subscriptions</h3>

    <!-- Professional Tiffin Subscription Form -->
    <div class="tiffin-container" style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 20px;">

      <!-- Form Panel -->
      <form [formGroup]="tiffinForm" class="tiffin-form"
        style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h4 style="grid-column: 1 / -1; margin-top: 0;">New Subscription</h4>

        <div class="form-row">
          <label>Customer Name</label>
          <input type="text" formControlName="customerName" placeholder="Full Name" />
        </div>
        <div class="form-row">
          <label>Mobile Number</label>
          <input type="tel" formControlName="customerPhone" placeholder="10-digit Mobile" />
        </div>

        <div class="form-row" style="grid-column: 1 / -1;">
          <label>Delivery Address</label>
          <textarea formControlName="address" rows="2" placeholder="Flat No, Building, Landmark"></textarea>
        </div>

        <div class="form-row">
          <label>Select Plan (Menu Item)</label>
          <select formControlName="menuItemId">
            <option [ngValue]="null">-- Select Tiffin Plan --</option>
            <option *ngFor="let m of tiffinMenuItems" [value]="m.id">{{ m.name }} (‚Çπ{{ m.price }}/day)</option>
          </select>
          <small *ngIf="tiffinMenuItems.length === 0" style="color: red;">No 'TIFFIN' category items found in
            menu.</small>
        </div>

        <div class="form-row">
          <label>Duration (Months)</label>
          <input type="number" formControlName="durationMonths" min="1" max="12" />
        </div>

        <button type="button" class="btn primary-btn" style="grid-column: 1 / -1; margin-top: 10px;"
          (click)="createTiffin()" [disabled]="tiffinForm.invalid || !tiffinCalculation">
          Create Subscription
        </button>
      </form>

      <!-- Pricing Preview Panel -->
      <div *ngIf="tiffinCalculation" class="pricing-card"
        style="width: 300px; background: #e3f2fd; padding: 20px; border-radius: 8px; border: 1px solid #90caf9;">
        <h4 style="margin-top: 0; color: #1565c0;">üí∞ Price Breakdown</h4>

        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>Daily Rate:</span>
          <strong>‚Çπ{{ tiffinCalculation.dailyPrice }}</strong>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>Duration:</span>
          <span>{{ tiffinCalculation.months }} Month(s)</span>
        </div>
        <hr style="border-color: #bbdefb;">

        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #757575;">
          <span>Standard (30 days/mo):</span>
          <span style="text-decoration: line-through;">‚Çπ{{ tiffinCalculation.dailyPrice * 30 * tiffinCalculation.months
            }}</span>
        </div>

        <div
          style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #2e7d32; font-weight: bold;">
          <span>Pro Deal (28 days/mo):</span>
          <span>‚Çπ{{ tiffinCalculation.finalPrice }}</span>
        </div>

        <div
          style="margin-top: 10px; background: #c8e6c9; color: #1b5e20; padding: 8px; border-radius: 4px; text-align: center; font-size: 0.9em;">
          üéâ You save <strong>‚Çπ{{ tiffinCalculation.saved }}</strong>!<br>
          <small>(2 Free Meals / Month)</small>
        </div>
      </div>
    </div>

    <!-- Tiffin List -->
    <!-- Tiffin List -->
    <table class="orders-table" *ngIf="subscriptionsList.length > 0">
      <thead>
        <tr>
          <th>Status</th>
          <th>Customer</th>
          <th>Plan</th>
          <th>Dates (Start - End)</th>
          <th>Max Extension</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of subscriptionsList">
          <td>
            <span class="badge" [class.badge-ready]="s.status === 'ACTIVE'"
              [class.badge-pending]="s.status === 'PAUSED'">
              {{ s.status }}
            </span>
          </td>
          <td>
            {{ s.customerName }}<br>
            <small>{{ s.customerPhone }}</small>
          </td>
          <td>
            {{ s.menuItemName || 'Tiffin' }}<br>
            <small>‚Çπ{{ s.finalAmount }} / {{ s.durationMonths }} mo</small>
          </td>
          <td>
            {{ s.startDate | date:'shortDate' }} - {{ s.endDate | date:'shortDate' }}
            <div *ngIf="s.status === 'PAUSED'" style="color: red; font-size: 0.8em;">
              Paused since: {{ s.pausedAt | date:'medium' }}
            </div>
          </td>
          <td>
            <span style="color: #d32f2f;">{{ s.maxEndDate | date:'shortDate' }}</span>
          </td>
          <td>
            <button class="btn primary-btn" style="padding: 5px 10px; font-size: 0.9em;"
              [style.background-color]="s.status === 'ACTIVE' ? '#fbc02d' : '#4caf50'"
              (click)="toggleSubscriptionStatus(s)">
              {{ s.status === 'ACTIVE' ? '‚è∏ Pause' : '‚ñ∂ Resume' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <p *ngIf="subscriptionsList.length === 0" class="no-data">No active subscriptions</p>
  </div>

  <!-- ========== ONGOING ORDERS TAB ========== -->
  <div *ngIf="activeTab === 'ONGOING'" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3>‚è≥ Ongoing Orders</h3>
      <select [(ngModel)]="ongoingSortOption" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
        <option value="newest">üìÖ Newest First</option>
        <option value="oldest">üìÖ Oldest First</option>
        <option value="customer_asc">üë§ Customer (A-Z)</option>
        <option value="customer_desc">üë§ Customer (Z-A)</option>
      </select>
    </div>

    <table class="orders-table" *ngIf="sortedOngoingOrders.length > 0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Table/Customer</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of sortedOngoingOrders">
          <td>#{{ o.id }}</td>
          <td>
            <span *ngIf="o.tableNumber" class="badge table-badge">Table {{ o.tableNumber }}</span>
            <span *ngIf="!o.tableNumber">{{ o.customerName || 'Guest' }}</span>
          </td>
          <td>
            <div class="items-summary">
              {{ o.items?.length || 0 }} items
              <span class="items-tooltip">
                <div *ngFor="let i of o.items">
                  {{ i.qty || i.quantity }}x {{ i.name || i.itemName }}
                </div>
              </span>
            </div>
          </td>
          <td class="total-cell">‚Çπ{{ o.totalAmount || o.total }}</td>
          <td>
            <span class="badge" [class.badge-pending]="o.status === 'PENDING' || o.status === 'PREPARING'"
              [class.badge-ready]="o.status === 'READY' || o.status === 'PREPARED'"
              [class.badge-delivered]="o.status === 'DELIVERED'">
              {{ o.status }}
            </span>
          </td>
          <td>
            <button class="btn share-btn" style="margin-right: 5px; background-color: #25D366; color: white;"
              (click)="shareBill(o)" title="Share on WhatsApp">
              <i class="fa fa-whatsapp"></i> Share
            </button>
            <button class="btn primary-btn" (click)="openEdit(o)">Edit</button>
            <button class="btn primary-btn" style="margin-left: 5px; background-color: #9C27B0; border-color: #9C27B0;"
              *ngIf="o.status === 'PENDING' || o.status === 'PREPARING' || o.status === 'READY'"
              (click)="markAsServed(o)">
              Serve
            </button>
            <button class="btn primary-btn" style="margin-left: 5px; background-color: #E67E22; border-color: #E67E22;"
              *ngIf="o.status === 'DELIVERED' || o.status === 'READY'" (click)="openPayment(o)">
              Pay
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <p *ngIf="ongoingOrders.length === 0" class="no-data">No ongoing orders right now</p>
  </div>

  <!-- ========== SHIFT SUMMARY TAB ========== -->
  <div *ngIf="activeTab === 'REVENUE'" class="tab-content revenue-tab">
    <h3>üìù Shift Summary (Today)</h3>

    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-label">Total Orders</div>
        <div class="stat-value">{{ todayOrders.length }}</div>
      </div>
      <!-- Modified for Staff Privacy: Count only, no Revenue Amount -->
      <div class="stat-box">
        <div class="stat-label">Cash Orders</div>
        <div class="stat-value">{{ getCashOrdersCount() }}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Online/UPI Orders</div>
        <div class="stat-value">{{ getOnlineOrdersCount() }}</div>
      </div>
    </div>

    <!-- Chart hidden for Staff as per privacy policy -->
    <!-- <div class="chart-container" *ngIf="revenueChartData && revenueChartOptions">
      <canvas baseChart [data]="revenueChartData" [options]="revenueChartOptions" type="bar"></canvas>
    </div> -->

    <table class="orders-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Customer</th>
          <th>Items</th>
          <th>Total</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of todayOrders">
          <td>#{{ o.id }}</td>
          <td>{{ o.customerName }}</td>
          <td>{{ o.items?.length || 0 }} items</td>
          <td>‚Çπ{{ o.total }}</td>
          <td><span class="badge">{{ o.status }}</span></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ========== EDIT ORDER MODAL ========== -->
  <div *ngIf="showEditModal && editOrder" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Edit Order #{{ editOrder.id }}</h3>
        <button class="close-btn" (click)="closeEdit()">‚úï</button>
      </div>

      <div class="modal-body">
        <!-- Add Items Grid -->
        <h4>Add Items</h4>
        <div class="menu-grid-small">
          <div class="menu-item-small" *ngFor="let item of filteredMenu">
            <img [src]="item.imageUrl" [alt]="item.name" />
            <div class="item-info-small">
              <div class="item-name-small">{{ item.name }}</div>
              <div class="item-price-small">‚Çπ{{ item.price }}</div>
              <button class="btn" (click)="addItemToEdit(item)">+ Add</button>
            </div>
          </div>
        </div>

        <!-- Edit Items -->
        <h4>Order Items</h4>
        <div class="edit-items">
          <div *ngFor="let item of editOrder.items; let i = index" class="edit-item">
            <div class="edit-item-info">
              <div class="edit-item-name">{{ item.name }}</div>
              <div class="edit-item-price">‚Çπ{{ item.price }}</div>
            </div>

            <div class="qty-control">
              <button class="qty-btn" (click)="decreaseQty(item)">‚àí</button>
              <span class="qty">{{ item.qty }}</span>
              <button class="qty-btn" (click)="increaseQty(item)">+</button>
            </div>

            <button class="remove-btn" (click)="removeItemFromEdit(i)">Remove</button>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" (click)="closeEdit()">Cancel</button>
        <button class="btn primary-btn" (click)="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>


  <!-- Payment Modal -->
  <div class="modal-backdrop" *ngIf="showPaymentModal" (click)="closePayment()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 *ngIf="!pendingTiffinPayload">üí∞ Confirm Payment</h3>
        <h3 *ngIf="pendingTiffinPayload">üç± Start Subscription</h3>
        <button class="close-btn" (click)="closePayment()">&times;</button>
      </div>
      <div class="modal-body">
        <h4>{{ pendingTiffinPayload ? 'Subscription Total:' : 'Total Amount:' }} <span
            style="color: #27AE60; font-size: 1.2rem;">‚Çπ{{ payOrder?.totalAmount || payOrder?.total
            }}</span></h4>

        <!-- QR Code Section -->
        <div *ngIf="paymentMode === 'UPI' && paymentConfig?.qrImageUrl" style="text-align: center; margin: 1rem 0;">
          <img [src]="paymentConfig?.qrImageUrl" alt="Scan to Pay"
            style="width: 150px; height: 150px; border: 2px solid #27AE60; padding: 5px; border-radius: 10px;">
          <div style="margin-top: 5px; font-weight: 600; color: #555;">{{ paymentConfig?.upiId }}</div>
        </div>

        <div class="form-row" style="margin-top: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Select Payment Mode:</label>
          <div class="payment-options" style="display: flex; gap: 1rem;">
            <button class="btn" [class.active-mode]="paymentMode === 'CASH'" (click)="paymentMode = 'CASH'"
              style="flex: 1; border: 2px solid #ddd; background: white; color: #333;">
              üíµ Cash
            </button>
            <button class="btn" [class.active-mode]="paymentMode === 'UPI'" (click)="paymentMode = 'UPI'"
              style="flex: 1; border: 2px solid #ddd; background: white; color: #333;">
              üì± UPI / Online
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="closePayment()">Cancel</button>
        <button class="btn primary-btn" (click)="confirmPayment()">
          {{ pendingTiffinPayload ? 'Pay & Create' : 'Confirm Payment' }}
        </button>
      </div>
    </div>
  </div>
</div>