<div class="staff-pos-container">
  <!-- Header -->
  <div class="header-row">
    <div style="display: flex; gap: 15px; align-items: center;">
      <h2>üë®‚Äçüíº Staff POS</h2>
      <a routerLink="/staff/kitchen" class="btn secondary-btn"
        style="text-decoration: none; padding: 5px 10px; font-size: 0.9rem;">
        üë®‚Äçüç≥ Kitchen View
      </a>
    </div>
    <div class="tab-buttons">
      <button class="tab-btn" [class.active]="activeTab === 'ORDER'" (click)="switchTab('ORDER')">
        üõí Take Order
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'TIFFIN'" (click)="switchTab('TIFFIN')">
        üç± Tiffin
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'ONGOING'" (click)="switchTab('ONGOING')">
        ‚è≥ Ongoing
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'ONLINE'" (click)="switchTab('ONLINE')">
        üîî Online Orders <span *ngIf="onlineOrders.length > 0" class="badge-count">{{ onlineOrders.length }}</span>
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'UNPAID'" (click)="switchTab('UNPAID')">
        üí≥ Unpaid <span *ngIf="unpaidOrders.length > 0" class="badge-count" style="background:#c62828;">{{
          unpaidOrders.length }}</span>
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'REVENUE'" (click)="switchTab('REVENUE')">
        üìù Shift Summary
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'LEAVES'" (click)="switchTab('LEAVES')">
        üèñÔ∏è My Leaves
      </button>
    </div>
  </div>

  <!-- Message -->
  <div *ngIf="message" class="message">{{ message }}</div>

  <!-- ========== UNPAID ORDERS TAB ========== -->
  <div *ngIf="activeTab === 'UNPAID'" class="tab-content">
    <h3>üí≥ Served & Unpaid Orders</h3>
    <div class="table-wrapper">
      <table class="orders-table" *ngIf="unpaidOrders.length > 0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of unpaidOrders">
            <td>#{{ o.id }}</td>
            <td>
              {{ o.customerName || 'Guest' }}<br>
              <small>{{ o.customerPhone }}</small>
            </td>
            <td>{{ o.items?.length || 0 }} items</td>
            <td style="color: #c62828; font-weight: bold;">‚Çπ{{ o.totalAmount || o.total }}</td>
            <td>
              <span class="badge badge-delivered">SERVED / UNPAID</span>
            </td>
            <td>
              <button class="btn share-btn" style="margin-right: 5px; background-color: #3498DB; color: white;"
                (click)="shareBill(o)" title="View & Share Bill">
                <i class="fa fa-file-text-o"></i> Bill
              </button>
              <button class="btn primary-btn" style="background-color: #E67E22; border-color: #E67E22;"
                (click)="openPayment(o)">
                üí∞ Collect Payment
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <p *ngIf="unpaidOrders.length === 0" class="no-data">No unpaid orders! All clear. üéâ</p>
  </div>

  <!-- ========== TAKE ORDER TAB ========== -->
  <div *ngIf="activeTab === 'ORDER'" class="pos-layout">
    <!-- ... content ... -->
    <!-- (Using existing structure indirectly by not replacing it, just ensuring context match) -->
    <!-- Wait, replacing larger block for safety -->
    <div class="menu-section">
      <div class="search-bar" style="display: flex; gap: 10px;">
        <input type="text" [(ngModel)]="searchTerm" placeholder="üîç Search menu or category..." class="search-input" />
        <button class="btn" [class.primary-btn]="!isManageMode" [class.share-btn]="isManageMode"
          [style.background-color]="isManageMode ? '#E74C3C' : '#3498DB'" (click)="isManageMode = !isManageMode">
          {{ isManageMode ? 'Done Managing' : 'Manage Stock' }}
        </button>
      </div>
      <div *ngIf="isManageMode"
        style="background: #ffebee; color: #c62828; padding: 10px; margin-bottom: 10px; border-radius: 4px; text-align: center; border: 1px solid #ffcdd2;">
        ‚ö†Ô∏è <strong>Manage Mode Active</strong>: Tap items to toggle In Stock / Out of Stock
      </div>

      <div class="menu-grid">
        <div class="menu-item" *ngFor="let item of filteredMenu; trackBy: trackByItem"
          [class.out-of-stock]="item.isAvailable === false" [style.opacity]="item.isAvailable === false ? '0.6' : '1'">

          <div *ngIf="item.isAvailable === false"
            style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; z-index: 1; pointer-events: none;">
            <span
              style="background: red; color: white; padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; transform: rotate(-10deg);">OUT
              OF STOCK</span>
          </div>

          <img [src]="item.imageUrl" [alt]="item.name" />
          <div class="meta">
            <div class="name">{{ item.name }}</div>
            <div class="category">{{ item.category }}</div>
            <div class="price">‚Çπ{{ item.price }}</div>
          </div>
          <button class="btn add" (click)="addItem(item)"
            [style.background-color]="isManageMode ? (item.isAvailable !== false ? '#E74C3C' : '#27AE60') : ''">
            {{ isManageMode ? (item.isAvailable !== false ? 'üö´ Disable' : '‚úÖ Enable') : '+ Add' }}
          </button>
        </div>
      </div>
    </div>

    <!-- FAB: Floating Cart Bar (Mobile/Standard) -->
    <div class="fab-cart-bar" *ngIf="cartItems.length > 0" (click)="toggleCart()">
      <div class="fab-info">
        <span class="count">{{ cartItems.length }} Item(s)</span>
        <span class="pipe">|</span>
        <span class="total">‚Çπ{{ getTotal(cartItems) }}</span>
      </div>
      <div class="fab-action">
        View Cart üõí
      </div>
    </div>

    <!-- CART MODAL (Instead of sticky side) -->
    <div class="modal-backdrop" *ngIf="showCartModal" (click)="toggleCart()">
      <div class="modal cart-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>üõí Current Order</h3>
          <button class="close-btn" (click)="toggleCart()">‚úï</button>
        </div>

        <div class="modal-body">
          <form [formGroup]="orderForm" class="order-form">
            <div class="form-row two-col">
              <div>
                <label>Table # <span style="color:red">*</span></label>
                <input type="number" formControlName="tableNumber" placeholder="0 = Standing" class="highlight-input" />
                <small style="color: #888; display: block; margin-top: 2px; font-size: 0.75rem;">
                  (0: Walk-in, >0: Append)
                </small>
              </div>
              <div>
                <label>Type</label>
                <select formControlName="orderType">
                  <option value="DINE_IN">Dine In</option>
                  <option value="TAKEAWAY">Takeaway</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <label>Customer Name</label>
              <input type="text" formControlName="customerName" placeholder="Guest Name" />
            </div>

            <div class="cart-items-list">
              <div *ngFor="let item of cartItems; let i = index" class="cart-item">
                <div class="item-name">{{ item.name }}</div>
                <div class="item-price">‚Çπ{{ item.price }}</div>
                <button class="remove-btn" (click)="removeItemFromOrder(i)">üóëÔ∏è</button>
              </div>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <div class="grand-total">Total: ‚Çπ{{ getTotal(cartItems) }}</div>
          <button class="btn clear-btn" (click)="clearCart(); toggleCart()">Clear</button>
          <button class="btn place-order-btn" (click)="placeOrder()"
            [disabled]="!orderForm.valid || cartItems.length === 0 || isLoading">
            {{ isLoading ? '‚è≥ Processing...' : '‚úÖ Place Order' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ONLINE ORDERS (VERIFICATION) TAB ========== -->
  <div *ngIf="activeTab === 'ONLINE'" class="tab-content">
    <h3>üîî Online Verification Queue</h3>
    <div class="table-wrapper">
      <table class="orders-table" *ngIf="onlineOrders.length > 0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of onlineOrders">
            <td>#{{ o.id }}</td>
            <td>{{ o.customerName || 'Guest' }}<br><small>{{ o.customerPhone }}</small></td>
            <td>{{ o.items?.length }} items</td>
            <td>‚Çπ{{ o.total }}</td>
            <td>
              <div *ngIf="o.paymentStatus === 'VERIFICATION_PENDING'" style="color:orange; font-weight:bold;">‚ö† Proof
                Uploaded</div>
              <div *ngIf="o.paymentMode === 'CASH' && o.status === 'PENDING'" style="color:blue; font-weight:bold;">üíµ
                Pay
                at Counter</div>
              <div *ngIf="o.paymentProof" style="font-size:0.8em;">Ref: {{ o.paymentProof }}</div>
            </td>
            <td>
              <button class="btn primary-btn" style="background-color: #27AE60;" (click)="verifyPayment(o)">
                ‚úÖ Verify & Accept
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <p *ngIf="onlineOrders.length === 0" class="no-data">No pending online orders! üéâ</p>
  </div>



  <!-- ========== TIFFIN TAB ========== -->
  <div *ngIf="activeTab === 'TIFFIN'" class="tab-content">
    <h3>üç± Tiffin Subscriptions</h3>

    <!-- Professional Tiffin Subscription Form -->
    <div class="tiffin-container" style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 20px;">

      <!-- Form Panel -->
      <form [formGroup]="tiffinForm" class="tiffin-form"
        style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h4 style="grid-column: 1 / -1; margin-top: 0;">New Subscription</h4>

        <div class="form-row">
          <label>Customer Name</label>
          <input type="text" formControlName="customerName" placeholder="Full Name" />
        </div>
        <div class="form-row">
          <label>Mobile Number</label>
          <input type="tel" formControlName="customerPhone" placeholder="10-digit Mobile" />
        </div>

        <div class="form-row" style="grid-column: 1 / -1;">
          <label>Delivery Address</label>
          <textarea formControlName="address" rows="2" placeholder="Flat No, Building, Landmark"></textarea>
        </div>

        <div class="form-row">
          <label>Select Plan (Menu Item)</label>
          <select formControlName="menuItemId">
            <option [ngValue]="null">-- Select Tiffin Plan --</option>
            <option *ngFor="let m of tiffinMenuItems" [value]="m.id">{{ m.name }} (‚Çπ{{ m.price }}/day)</option>
          </select>
          <small *ngIf="tiffinMenuItems.length === 0" style="color: red;">No 'TIFFIN' category items found in
            menu.</small>
        </div>

        <div class="form-row">
          <label>Duration (Months)</label>
          <input type="number" formControlName="durationMonths" min="1" max="12" />
        </div>

        <button type="button" class="btn primary-btn" style="grid-column: 1 / -1; margin-top: 10px;"
          (click)="createTiffin()" [disabled]="tiffinForm.invalid || !tiffinCalculation">
          Create Subscription
        </button>
      </form>

      <!-- Pricing Preview Panel -->
      <div *ngIf="tiffinCalculation" class="pricing-card"
        style="width: 300px; background: #e3f2fd; padding: 20px; border-radius: 8px; border: 1px solid #90caf9;">
        <h4 style="margin-top: 0; color: #1565c0;">üí∞ Price Breakdown</h4>

        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>Daily Rate:</span>
          <strong>‚Çπ{{ tiffinCalculation.dailyPrice }}</strong>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span>Duration:</span>
          <span>{{ tiffinCalculation.months }} Month(s)</span>
        </div>
        <hr style="border-color: #bbdefb;">

        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #757575;">
          <span>Standard (30 days/mo):</span>
          <span style="text-decoration: line-through;">‚Çπ{{ tiffinCalculation.dailyPrice * 30 * tiffinCalculation.months
            }}</span>
        </div>

        <div
          style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #2e7d32; font-weight: bold;">
          <span>Pro Deal (28 days/mo):</span>
          <span>‚Çπ{{ tiffinCalculation.finalPrice }}</span>
        </div>

        <div
          style="margin-top: 10px; background: #c8e6c9; color: #1b5e20; padding: 8px; border-radius: 4px; text-align: center; font-size: 0.9em;">
          üéâ You save <strong>‚Çπ{{ tiffinCalculation.saved }}</strong>!<br>
          <small>(2 Free Meals / Month)</small>
        </div>
      </div>
    </div>

    <!-- Tiffin List -->
    <div class="table-wrapper">
      <table class="orders-table" *ngIf="subscriptionsList.length > 0">
        <thead>
          <tr>
            <th>Status</th>
            <th>Customer</th>
            <th>Plan</th>
            <th>Dates (Start - End)</th>
            <th>Max Extension</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of subscriptionsList">
            <td>
              <span class="badge" [class.badge-ready]="s.status === 'ACTIVE'"
                [class.badge-pending]="s.status === 'PAUSED'">
                {{ s.status }}
              </span>
            </td>
            <td>
              {{ s.customerName }}<br>
              <small>{{ s.customerPhone }}</small>
            </td>
            <td>
              {{ s.menuItemName || 'Tiffin' }}<br>
              <small>‚Çπ{{ s.finalAmount }} / {{ s.durationMonths }} mo</small>
            </td>
            <td>
              {{ s.startDate | date:'shortDate' }} - {{ s.endDate | date:'shortDate' }}
              <div *ngIf="s.status === 'PAUSED'" style="color: red; font-size: 0.8em;">
                Paused since: {{ s.pausedAt | date:'medium' }}
              </div>
            </td>
            <td>
              <span style="color: #d32f2f;">{{ s.maxEndDate | date:'shortDate' }}</span>
            </td>
            <td>
              <button class="btn primary-btn" style="padding: 5px 10px; font-size: 0.9em;"
                [style.background-color]="s.status === 'ACTIVE' ? '#fbc02d' : '#4caf50'"
                (click)="toggleSubscriptionStatus(s)">
                {{ s.status === 'ACTIVE' ? '‚è∏ Pause' : '‚ñ∂ Resume' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <p *ngIf="subscriptionsList.length === 0" class="no-data">No active subscriptions</p>
  </div>

  <!-- ========== ONGOING ORDERS TAB ========== -->
  <div *ngIf="activeTab === 'ONGOING'" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3>‚è≥ Ongoing Orders</h3>
      <select [(ngModel)]="ongoingSortOption" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
        <option value="newest">üìÖ Newest First</option>
        <option value="oldest">üìÖ Oldest First</option>
        <option value="customer_asc">üë§ Customer (A-Z)</option>
        <option value="customer_desc">üë§ Customer (Z-A)</option>
      </select>
    </div>

    <div class="table-wrapper">
      <table class="orders-table" *ngIf="sortedOngoingOrders.length > 0">
        <thead>
          <tr>
            <th>ID</th>
            <th>Table/Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of sortedOngoingOrders">
            <td>#{{ o.id }}</td>
            <td>
              <span *ngIf="o.tableNumber" class="badge table-badge">Table {{ o.tableNumber }}</span>
              <span *ngIf="!o.tableNumber">{{ o.customerName || 'Guest' }}</span>
            </td>
            <td>
              <div class="items-summary">
                {{ o.items?.length || 0 }} items
                <span class="items-tooltip">
                  <div *ngFor="let i of o.items">
                    <span [style.color]="i.status === 'PREPARING' ? '#E67E22' : '#27AE60'"
                      [style.fontWeight]="i.status === 'PREPARING' ? 'bold' : 'normal'">
                      {{ i.qty || i.quantity }}x {{ i.name || i.itemName }}
                      <small *ngIf="i.status === 'PREPARING'"> (üïí Prep)</small>
                      <small *ngIf="i.status === 'READY'"> (‚úÖ Ready)</small>
                    </span>
                  </div>
                </span>
              </div>
            </td>
            <td class="total-cell">‚Çπ{{ o.totalAmount || o.total }}</td>
            <td>
              <span class="badge" [class.badge-pending]="o.status === 'PENDING' || o.status === 'PREPARING'"
                [class.badge-ready]="o.status === 'READY' || o.status === 'PREPARED'"
                [class.badge-delivered]="o.status === 'DELIVERED'">
                {{ o.status }}
              </span>
            </td>
            <td>
              <button class="btn share-btn" style="margin-right: 5px; background-color: #3498DB; color: white;"
                (click)="shareBill(o)" title="View & Share Bill">
                <i class="fa fa-file-text-o"></i> View Bill
              </button>
              <button class="btn primary-btn" (click)="openEdit(o)">Edit</button>
              <button class="btn primary-btn"
                style="margin-left: 5px; background-color: #9C27B0; border-color: #9C27B0;"
                *ngIf="o.status === 'PENDING' || o.status === 'PREPARING' || o.status === 'READY'"
                (click)="markAsServed(o)">
                Serve
              </button>
              <button class="btn primary-btn"
                style="margin-left: 5px; background-color: #E67E22; border-color: #E67E22;"
                *ngIf="o.paymentStatus !== 'COMPLETED' && o.paymentStatus !== 'PAID'" (click)="openPayment(o)">
                Pay
              </button>
              <button class="btn primary-btn"
                style="margin-left: 5px; background-color: #27AE60; border-color: #27AE60; cursor: default;"
                *ngIf="o.paymentStatus === 'COMPLETED' || o.paymentStatus === 'PAID'" disabled>
                ‚úÖ Paid
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <p *ngIf="ongoingOrders.length === 0" class="no-data">No ongoing orders right now</p>
  </div>

  <!-- ========== SHIFT SUMMARY TAB ========== -->
  <div *ngIf="activeTab === 'REVENUE'" class="tab-content revenue-tab">
    <h3>üìù Shift Summary (Today)</h3>

    <div class="stats-row">
      <div class="stat-box">
        <div class="stat-label">Total Orders</div>
        <div class="stat-value">{{ todayOrders.length }}</div>
      </div>
      <!-- Modified for Staff Privacy: Count only, no Revenue Amount -->
      <div class="stat-box">
        <div class="stat-label">Cash Orders</div>
        <div class="stat-value">{{ getCashOrdersCount() }}</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Online/UPI Orders</div>
        <div class="stat-value">{{ getOnlineOrdersCount() }}</div>
      </div>
    </div>

    <!-- Chart hidden for Staff as per privacy policy -->
    <!-- <div class="chart-container" *ngIf="revenueChartData && revenueChartOptions">
      <canvas baseChart [data]="revenueChartData" [options]="revenueChartOptions" type="bar"></canvas>
    </div> -->

    <div class="table-wrapper">
      <table class="orders-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of todayOrders">
            <td>#{{ o.id }}</td>
            <td>{{ o.customerName }}</td>
            <td>{{ o.items?.length || 0 }} items</td>
            <td>‚Çπ{{ o.total }}</td>
            <td><span class="badge">{{ o.status }}</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ========== LEAVES TAB ========== -->
  <div *ngIf="activeTab === 'LEAVES'" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3>üèñÔ∏è My Leave History</h3>
      <button class="btn primary-btn" (click)="openLeaveModal()">+ Apply for Leave</button>
    </div>

    <div class="table-wrapper">
      <table class="orders-table">
        <thead>
          <tr>
            <th>DateApplied</th>
            <th>Period</th>
            <th>Days</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Admin Note</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let l of myLeaves">
            <td>#{{ l.id }}</td>
            <td>{{ l.startDate }} to {{ l.endDate }}</td>
            <td>
              {{ getLeaveDuration(l.startDate, l.endDate) }} Days
            </td>
            <td>{{ l.reason }}</td>
            <td>
              <span class="badge" [class.badge-ready]="l.status === 'APPROVED'"
                [class.badge-pending]="l.status === 'PENDING'"
                [style.background-color]="l.status === 'REJECTED' ? '#ffebee' : ''"
                [style.color]="l.status === 'REJECTED' ? '#c62828' : ''">
                {{ l.status }}
              </span>
            </td>
            <td>{{ l.adminComments || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <p *ngIf="myLeaves.length === 0" class="no-data">No leave applications yet.</p>
  </div>

  <!-- LEAVE APPLICATION MODAL -->
  <div class="modal-backdrop" *ngIf="showLeaveModal" (click)="closeLeaveModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üèñÔ∏è Apply for Leave</h3>
        <button class="close-btn" (click)="closeLeaveModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="leaveForm" (ngSubmit)="applyForLeave()">
          <div class="form-row">
            <label>Start Date</label>
            <input type="date" formControlName="startDate">
          </div>
          <div class="form-row">
            <label>End Date</label>
            <input type="date" formControlName="endDate">
          </div>
          <div class="form-row">
            <label>Reason</label>
            <textarea formControlName="reason" rows="3" placeholder="e.g. Family Function"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" (click)="closeLeaveModal()">Cancel</button>
            <button type="submit" class="btn primary-btn" [disabled]="leaveForm.invalid || isLoading">Submit
              Application</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ========== EDIT ORDER MODAL ========== -->
  <div *ngIf="showEditModal && editOrder" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Edit Order #{{ editOrder.id }}</h3>
        <button class="close-btn" (click)="closeEdit()">‚úï</button>
      </div>

      <div class="modal-body">
        <!-- Add Items Grid -->
        <h4>Add Items</h4>
        <div class="menu-grid-small">
          <div class="menu-item-small" *ngFor="let item of filteredMenu">
            <img [src]="item.imageUrl" [alt]="item.name" />
            <div class="item-info-small">
              <div class="item-name-small">{{ item.name }}</div>
              <div class="item-price-small">‚Çπ{{ item.price }}</div>
              <button class="btn" (click)="addItemToEdit(item)">+ Add</button>
            </div>
          </div>
        </div>

        <!-- Edit Items -->
        <h4>Order Items</h4>
        <div class="edit-items">
          <div *ngFor="let item of editOrder.items; let i = index" class="edit-item">
            <div class="edit-item-info">
              <div class="edit-item-name">{{ item.name }}</div>
              <div class="edit-item-price">‚Çπ{{ item.price }}</div>
            </div>

            <div class="qty-control">
              <button class="qty-btn" (click)="decreaseQty(item)">‚àí</button>
              <span class="qty">{{ item.qty }}</span>
              <button class="qty-btn" (click)="increaseQty(item)">+</button>
            </div>

            <button class="remove-btn" (click)="removeItemFromEdit(i)">Remove</button>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn" (click)="closeEdit()">Cancel</button>
        <button class="btn primary-btn" (click)="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>


  <!-- Payment Modal -->
  <div class="modal-backdrop" *ngIf="showPaymentModal" (click)="closePayment()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 *ngIf="!pendingTiffinPayload">üí∞ Confirm Payment</h3>
        <h3 *ngIf="pendingTiffinPayload">üç± Start Subscription</h3>
        <button class="close-btn" (click)="closePayment()">&times;</button>
      </div>
      <div class="modal-body">
        <h4>{{ pendingTiffinPayload ? 'Subscription Total:' : 'Total Amount:' }} <span
            style="color: #27AE60; font-size: 1.2rem;">‚Çπ{{ payOrder?.totalAmount || payOrder?.total
            }}</span></h4>

        <!-- QR Code Section -->
        <div *ngIf="paymentMode === 'UPI' && paymentConfig?.upiQrImageUrl" style="text-align: center; margin: 1rem 0;">
          <img [src]="paymentConfig?.upiQrImageUrl" alt="Scan to Pay"
            style="width: 150px; height: 150px; border: 2px solid #27AE60; padding: 5px; border-radius: 10px;">
          <div style="margin-top: 5px; font-weight: 600; color: #555;">{{ paymentConfig?.upiId }}</div>
        </div>

        <div class="form-row" style="margin-top: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 700;">Select Payment Mode:</label>
          <div class="payment-options" style="display: flex; gap: 1rem;">
            <button class="btn" [class.active-mode]="paymentMode === 'CASH'" (click)="paymentMode = 'CASH'"
              style="flex: 1; border: 2px solid #ddd; background: white; color: #333;">
              üíµ Cash
            </button>
            <button class="btn" [class.active-mode]="paymentMode === 'UPI'" (click)="paymentMode = 'UPI'"
              style="flex: 1; border: 2px solid #ddd; background: white; color: #333;">
              üì± UPI / Online
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" (click)="closePayment()">Cancel</button>
        <button class="btn primary-btn" (click)="confirmPayment()">
          {{ pendingTiffinPayload ? 'Pay & Create' : 'Confirm Payment' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Bill / Share Modal -->
  <div class="modal-backdrop" *ngIf="showBillModal && viewBillOrder" (click)="closeBillModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üßæ Order Summary #{{ viewBillOrder.id }}</h3>
        <button class="close-btn" (click)="closeBillModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="bill-details"
          style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace;">
          <div style="border-bottom: 1px dashed #ccc; padding-bottom: 10px; margin-bottom: 10px;">
            <strong>Customer:</strong> {{ viewBillOrder.customerName }}<br>
            <strong>Phone:</strong> {{ viewBillOrder.customerPhone }}<br>
            <strong>Date:</strong> {{ viewBillOrder.createdAt | date:'short' }}
          </div>
          <div *ngFor="let item of viewBillOrder.items"
            style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>{{ item.qty }}x {{ item.name }}</span>
            <span>‚Çπ{{ item.price * item.qty }}</span>
          </div>
          <div
            style="border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em;">
            <span>TOTAL</span>
            <span>‚Çπ{{ viewBillOrder.total }}</span>
          </div>
        </div>

        <h4 style="margin-bottom: 10px;">Share Bill via:</h4>
        <div class="payment-options" style="display: flex; gap: 1rem;">
          <button class="btn" style="flex: 1; background: #25D366; color: white;" (click)="confirmShare('WHATSAPP')">
            <i class="fa fa-whatsapp"></i> WhatsApp
          </button>
          <button class="btn" style="flex: 1; background: #3498DB; color: white;" (click)="confirmShare('SMS')">
            <i class="fa fa-commenting-o"></i> SMS / Text
          </button>
        </div>
      </div>
    </div>
  </div>
</div>