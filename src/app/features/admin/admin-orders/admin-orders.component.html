<div class="admin-orders-container" *ngIf="!loading">

  <h2>
    ğŸ“‹ Manage Orders
  </h2>

  <div *ngIf="errorMsg" class="error-msg">{{ errorMsg }}</div>

  <!-- CONTROL CARD -->
  <div class="controls-card">
    <div class="refresh-indicator">
      <div class="pulse-dot"></div>
      Live Sync Active (5s)
    </div>

    <div class="sort-controls">
      <!-- Date Filter -->
      <div class="date-filter">
        <label>Filter Date:</label>
        <input type="date" [(ngModel)]="selectedDate">
        <button *ngIf="selectedDate" (click)="clearDateFilter()" class="clear-btn" title="Clear Date">
          âœ–
        </button>
      </div>

      <div class="sorting-group">
        <label>Sort by:</label>
        <select [(ngModel)]="sortOption">
          <option value="newest">ğŸ“… Date (Newest First)</option>
          <option value="oldest">ğŸ“… Date (Oldest First)</option>
          <option value="customer_asc">ğŸ‘¤ Customer Name (A-Z)</option>
          <option value="customer_desc">ğŸ‘¤ Customer Name (Z-A)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- TABLE WRAPPER (SCROLLABLE) -->
  <div class="table-wrapper" *ngIf="sortedOrders.length > 0; else noOrders">
    <table class="orders-table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Total</th>
          <th>Status</th>
          <th>Date</th>
          <th>Items</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let order of sortedOrders">
          <td><span class="order-id">#{{ order.id }}</span></td>
          <td>
            <div>
              <!-- Order Type Badges -->
              <div class="order-type-badge-container">
                {{ order.customerName }}
                <span *ngIf="order.orderType === 'DELIVERY'" class="badge-pill badge-delivery" title="Delivery">
                  ğŸ›µ Delivery
                </span>
                <span *ngIf="order.orderType === 'DINE_IN'" class="badge-pill badge-dinein" title="Dine-In">
                  ğŸ½ï¸ Dine-In
                </span>
                <span *ngIf="order.orderType === 'TAKEAWAY'" class="badge-pill badge-pickup" title="Pickup">
                  ğŸ¥¡ Pickup
                </span>
              </div>
              <div style="font-size: 0.8em; color: #999;">{{ order.customerEmail }}</div>
            </div>
          </td>
          <td style="font-weight: 700; color: #2D3436;">{{ order.total | currency:'INR' }}</td>
          <td>
            <!-- Status Badge -->
            <span class="status-badge" [ngClass]="order.status.toLowerCase()">
              {{ order.status.replace('_', ' ') }}
            </span>
            <!-- Logic: If Verification Pending or (PayAtCounter + Pending), show warning -->
            <div *ngIf="order.paymentStatus === 'VERIFICATION_PENDING'"
              style="font-size: 0.8em; color: orange; margin-top: 4px;">
              âš  Needs Approval
            </div>
            <div *ngIf="order.paymentProof" style="font-size: 0.8em; margin-top: 4px;">
              <span style="font-weight: bold;">Proof:</span> {{ order.paymentProof }}
            </div>
          </td>
          <td>{{ formatDate(order.createdAt) }}</td>
          <td>
            <ul class="items-list">
              <li *ngFor="let item of order.items">
                <span class="qty">{{ item.qty }}x</span> {{ item.name }}
              </li>
            </ul>
          </td>
          <td>
            <div class="actions-cell">
              <!-- Verify Button (Only for Pending/Verification Pending) -->
              <button
                *ngIf="order.paymentStatus === 'VERIFICATION_PENDING' || (order.paymentMode === 'CASH' && order.status === 'PENDING')"
                class="btn-verify" (click)="verifyPayment(order)" title="Verify Payment & Confirm Order">
                âœ… Verify
              </button>

              <!-- Assign Driver Button (Feature Flagged) -->
              <!-- RESTRICTED TO DELIVERY ORDERS ONLY -->
              @if (featureFlagStore.isFeatureEnabled('DELIVERY_MANAGEMENT')) {
              <button
                *ngIf="(order.status === 'READY' || order.status === 'PREPARING') && order.orderType === 'DELIVERY'"
                class="btn-assign" (click)="openAssignDriver(order)" title="Assign Delivery Driver">
                ğŸšš Assign Driver
              </button>
              }

              <select class="status-select" [value]="order.status" (change)="onStatusChange(order, $event)">
                <option value="PENDING">Pending</option>
                <option value="CONFIRMED">Confirmed</option>
                <option value="PREPARING">Preparing</option>
                <option value="READY">Ready</option>
                @if (featureFlagStore.isFeatureEnabled('DELIVERY_MANAGEMENT')) {
                <option value="OUT_FOR_DELIVERY">Out for Delivery</option>
                <option value="DELIVERED">Delivered</option>
                }
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #noOrders>
    <div class="empty-state">
      <p>No orders found yet! ğŸ”</p>
    </div>
  </ng-template>

  <!-- Modals -->
  <app-assign-driver-modal (assigned)="onDriverAssigned()">
  </app-assign-driver-modal>

</div>

<div *ngIf="loading" class="loader">
  <p>Processing orders...</p>
</div>