<div class="sa-container" *ngIf="group">
    <div class="header">
        <button mat-icon-button routerLink="/super-admin/groups">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <h1>{{ group.name }}</h1>
        <span class="spacer"></span>
        <button mat-raised-button color="primary" (click)="openAddRestaurantDialog()" style="margin-right: 12px;">
            <mat-icon>link</mat-icon> Add to Group
        </button>
        <button mat-stroked-button (click)="openEditGroupDialog()">Edit Group</button>
    </div>

    <!-- Overview Card -->
    <mat-card class="overview-card">
        <div class="overview-content">
            <div class="info-block">
                <span class="label">Status</span>
                <span class="value badge" [class]="group.status">{{ group.status }}</span>
            </div>
            <div class="info-block">
                <span class="label">Owner</span>
                <span class="value">{{ group.ownerName }}</span>
            </div>
            <div class="info-block">
                <span class="label">Billing Model</span>
                <span class="value">
                    {{ group.billingModel }}
                    <button mat-stroked-button color="primary" (click)="openUpgradePlanDialog()"
                        style="margin-left: 10px; height: 32px; line-height: 32px; font-size: 13px; padding: 0 12px;">
                        Change Plan
                    </button>
                </span>
            </div>
            <div class="info-block">
                <span class="label">Restaurants</span>
                <span class="value">{{ group.restaurantCount }}</span>
            </div>
        </div>
    </mat-card>

    <div class="tabs-container">
        <mat-tab-group>
            <mat-tab label="Analytics">
                <div class="tab-content" *ngIf="analytics; else loading">
                    <div class="stats-grid">
                        <mat-card class="stat-card">
                            <mat-card-header>
                                <mat-card-title>Total Revenue</mat-card-title>
                            </mat-card-header>
                            <mat-card-content>
                                <div class="stat-value">{{ analytics.totalRevenue | currency:'INR' }}</div>
                            </mat-card-content>
                        </mat-card>

                        <mat-card class="stat-card">
                            <mat-card-header>
                                <mat-card-title>Total Orders</mat-card-title>
                            </mat-card-header>
                            <mat-card-content>
                                <div class="stat-value">{{ analytics.totalOrders }}</div>
                            </mat-card-content>
                        </mat-card>

                        <mat-card class="stat-card">
                            <mat-card-header>
                                <mat-card-title>Active Restaurants</mat-card-title>
                            </mat-card-header>
                            <mat-card-content>
                                <div class="stat-value">{{ analytics.activeRestaurants }}</div>
                            </mat-card-content>
                        </mat-card>
                    </div>

                    <mat-card class="charts-card">
                        <h3>Monthly Revenue Trend (Mock)</h3>
                        <div class="chart-container">
                            <div class="bar-chart">
                                <div class="bar" style="height: 60%;" title="Jan: ₹5000"><span>Jan</span></div>
                                <div class="bar" style="height: 90%;" title="Feb: ₹7500"><span>Feb</span></div>
                                <div class="bar" style="height: 30%;" title="Mar: ₹2500"><span>Mar</span></div>
                            </div>
                        </div>
                    </mat-card>

                    <!-- NEW: Restaurant Performance Breakdown -->
                    <mat-card class="performance-card">
                        <div class="card-header">
                            <h3>Restaurant Performance Breakdown</h3>
                            <button mat-button color="primary" (click)="exportReport()">Export Report</button>
                        </div>

                        <div class="table-wrapper">
                            <table mat-table [dataSource]="performanceDataSource" matSort class="modern-table">

                                <!-- Restaurant Column -->
                                <ng-container matColumnDef="name">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Restaurant </th>
                                    <td mat-cell *matCellDef="let row">
                                        <strong>{{ row.name }}</strong>
                                        <div class="sub-text">{{ row.location || 'Branch ID: ' +
                                            row.restaurantId.substring(0,8) }}</div>
                                    </td>
                                </ng-container>

                                <!-- Revenue Column -->
                                <ng-container matColumnDef="revenue">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Revenue </th>
                                    <td mat-cell *matCellDef="let row" class="text-right highlight-teal">
                                        {{ row.revenue | currency:'INR' }}
                                    </td>
                                </ng-container>

                                <!-- Orders Column -->
                                <ng-container matColumnDef="orders">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Orders </th>
                                    <td mat-cell *matCellDef="let row" class="text-center">
                                        {{ row.orders }}
                                    </td>
                                </ng-container>

                                <!-- AOV Column -->
                                <ng-container matColumnDef="aov">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> AOV </th>
                                    <td mat-cell *matCellDef="let row" class="text-right">
                                        {{ row.averageOrderValue | currency:'INR' }}
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="performanceColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: performanceColumns;" class="hover-row"></tr>
                            </table>

                            <div *ngIf="performanceDataSource.data.length === 0" class="empty-state">
                                No sales data available for breakdown.
                            </div>
                        </div>
                    </mat-card>
                </div>
                <ng-template #loading>
                    <div class="tab-content">
                        <mat-spinner diameter="40"></mat-spinner>
                        <p>Loading analytics...</p>
                    </div>
                </ng-template>
            </mat-tab>

            <mat-tab label="Restaurants">
                <div class="tab-content">
                    <div class="tab-header">
                        <h3>Linked Restaurants</h3>
                        <button mat-raised-button color="primary" (click)="openAddRestaurantDialog()">
                            <mat-icon>add</mat-icon> Add Restaurant
                        </button>
                    </div>

                    <div *ngIf="group.restaurantCount === 0" class="empty-text">No restaurants assigned yet.</div>

                    <table mat-table [dataSource]="linkedRestaurants" *ngIf="group.restaurantCount > 0"
                        class="full-width-table">

                        <!-- Logo/Name Column -->
                        <ng-container matColumnDef="name">
                            <th mat-header-cell *matHeaderCellDef> Restaurant </th>
                            <td mat-cell *matCellDef="let element"> {{ element.restaurantName }} </td>
                        </ng-container>

                        <!-- Owner Column -->
                        <ng-container matColumnDef="owner">
                            <th mat-header-cell *matHeaderCellDef> Owner </th>
                            <td mat-cell *matCellDef="let element"> {{ element.ownerName }} </td>
                        </ng-container>

                        <!-- Status Column -->
                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef> Subscriber Status </th>
                            <td mat-cell *matCellDef="let element">
                                <span class="badge" *ngIf="element.status">{{ element.status }}</span>
                            </td>
                        </ng-container>

                        <!-- Actions Column -->
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef> Actions </th>
                            <td mat-cell *matCellDef="let element">
                                <button mat-icon-button color="warn" (click)="unlinkRestaurant(element.tenantId)"
                                    title="Unlink from Group">
                                    <mat-icon>link_off</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="['name', 'owner', 'status', 'actions']"></tr>
                        <tr mat-row *matRowDef="let row; columns: ['name', 'owner', 'status', 'actions'];"></tr>
                    </table>
                </div>
            </mat-tab>

            <mat-tab label="Billing & Invoices">
                <div class="tab-content">
                    <div class="tab-header">
                        <h3>Invoices</h3>
                    </div>
                    <div *ngIf="invoices.length === 0" class="empty-text">No invoices found for this group.</div>

                    <table mat-table [dataSource]="invoices" *ngIf="invoices.length > 0" class="full-width-table">
                        <ng-container matColumnDef="date">
                            <th mat-header-cell *matHeaderCellDef> Date </th>
                            <td mat-cell *matCellDef="let element"> {{ element.billingPeriod }} </td>
                        </ng-container>

                        <ng-container matColumnDef="amount">
                            <th mat-header-cell *matHeaderCellDef> Amount </th>
                            <td mat-cell *matCellDef="let element"> {{ element.totalAmount | currency:'INR' }} </td>
                        </ng-container>

                        <ng-container matColumnDef="status">
                            <th mat-header-cell *matHeaderCellDef> Status </th>
                            <td mat-cell *matCellDef="let element">
                                <span class="badge" [class.success]="element.status === 'PAID'">{{ element.status
                                    }}</span>
                            </td>
                        </ng-container>

                        <!-- Mock Action -->
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef> Actions </th>
                            <td mat-cell *matCellDef="let element">
                                <button mat-icon-button (click)="downloadInvoice(element.id)"
                                    title="Download PDF"><mat-icon>picture_as_pdf</mat-icon></button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="['date', 'amount', 'status', 'actions']"></tr>
                        <tr mat-row *matRowDef="let row; columns: ['date', 'amount', 'status', 'actions'];"></tr>
                    </table>
                </div>
            </mat-tab>
        </mat-tab-group>
    </div>
</div>